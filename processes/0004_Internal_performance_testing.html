<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>CDL Performance Testing - The Common Data Layer</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Common Data Layer</a></li><li class="chapter-item expanded "><a href="../how_it_works.html"><strong aria-hidden="true">2.</strong> How does it work</a></li><li class="chapter-item expanded "><a href="../getting_started.html"><strong aria-hidden="true">3.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../deployment/index.html"><strong aria-hidden="true">4.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/local/index.html"><strong aria-hidden="true">4.1.</strong> Local deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/local/docker-compose.html"><strong aria-hidden="true">4.1.1.</strong> docker-compose</a></li><li class="chapter-item expanded "><a href="../deployment/local/helm.html"><strong aria-hidden="true">4.1.2.</strong> Helm</a></li></ol></li><li class="chapter-item expanded "><a href="../deployment/production/index.html"><strong aria-hidden="true">4.2.</strong> Production-grade deployment</a></li></ol></li><li class="chapter-item expanded "><a href="../schemas_and_views.html"><strong aria-hidden="true">5.</strong> Schemas and Views</a></li><li class="chapter-item expanded "><a href="../examples/index.html"><strong aria-hidden="true">6.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/materialization.html"><strong aria-hidden="true">6.1.</strong> Materialization</a></li></ol></li><li class="chapter-item expanded "><a href="../features/index.html"><strong aria-hidden="true">7.</strong> Features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../features/ordering.html"><strong aria-hidden="true">7.1.</strong> Message ordering</a></li><li class="chapter-item expanded "><a href="../features/client_routing.html"><strong aria-hidden="true">7.2.</strong> Client routing</a></li></ol></li><li class="chapter-item expanded "><a href="../processes/index.html"><strong aria-hidden="true">8.</strong> Processes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../processes/0001_Commit_message_formalization_and_enforcement.html"><strong aria-hidden="true">8.1.</strong> Commit message formalization and enforcement</a></li><li class="chapter-item expanded "><a href="../processes/0002_Branching_strategy.html"><strong aria-hidden="true">8.2.</strong> Branhing strategy</a></li><li class="chapter-item expanded "><a href="../processes/0003_Documentation_structure_and_RFC_process.html"><strong aria-hidden="true">8.3.</strong> Documentation structure and RFC process</a></li><li class="chapter-item expanded "><a href="../processes/0004_Internal_performance_testing.html" class="active"><strong aria-hidden="true">8.4.</strong> CDL Performance Testing</a></li></ol></li><li class="chapter-item expanded "><a href="../versioning.html"><strong aria-hidden="true">9.</strong> Versioning</a></li><li class="chapter-item expanded "><a href="../stability.html"><strong aria-hidden="true">10.</strong> Stability</a></li><li class="chapter-item expanded "><a href="../protocol.html"><strong aria-hidden="true">11.</strong> Protocol schema</a></li><li class="chapter-item expanded "><a href="../benchmarks.html"><strong aria-hidden="true">12.</strong> Benchmarks</a></li><li class="chapter-item expanded "><a href="../architecture/index.html"><strong aria-hidden="true">13.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/management.html"><strong aria-hidden="true">13.1.</strong> Management Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/cli.html"><strong aria-hidden="true">13.1.1.</strong> CLI</a></li><li class="chapter-item expanded "><a href="../architecture/web_admin.html"><strong aria-hidden="true">13.1.2.</strong> Admin Web Panel</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/api.html"><strong aria-hidden="true">13.2.</strong> GraphQL API</a></li><li class="chapter-item expanded "><a href="../architecture/configuration.html"><strong aria-hidden="true">13.3.</strong> Configuration Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/schema_registry.html"><strong aria-hidden="true">13.3.1.</strong> Schema Registry</a></li><li class="chapter-item expanded "><a href="../architecture/leader_elector.html"><strong aria-hidden="true">13.3.2.</strong> Leader Elector</a></li><li class="chapter-item expanded "><a href="../architecture/edge_registry.html"><strong aria-hidden="true">13.3.3.</strong> Edge Registry</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/ingestion.html"><strong aria-hidden="true">13.4.</strong> Ingestion Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/data_router.html"><strong aria-hidden="true">13.4.1.</strong> Data Router</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/storage.html"><strong aria-hidden="true">13.5.</strong> Storage Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/command_service.html"><strong aria-hidden="true">13.5.1.</strong> Command Service</a></li><li class="chapter-item expanded "><a href="../architecture/db_shrinker_storage.html"><strong aria-hidden="true">13.5.2.</strong> Db Shrinker Storage</a></li><li class="chapter-item expanded "><a href="../architecture/query_service.html"><strong aria-hidden="true">13.5.3.</strong> Query Service</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.6.</strong> Materialization Layer</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/object_builder.html"><strong aria-hidden="true">13.6.1.</strong> Object Builder</a></li><li class="chapter-item expanded "><a href="../architecture/partial_update_engine.html"><strong aria-hidden="true">13.6.2.</strong> Partial Update Engine</a></li><li class="chapter-item expanded "><a href="../architecture/materializer_general.html"><strong aria-hidden="true">13.6.3.</strong> General Materializer</a></li><li class="chapter-item expanded "><a href="../architecture/materializer_ondemand.html"><strong aria-hidden="true">13.6.4.</strong> On Demand Materializer</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/retrieval.html"><strong aria-hidden="true">13.7.</strong> Retrieval Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/query_router.html"><strong aria-hidden="true">13.7.1.</strong> Query Router</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/utils.html"><strong aria-hidden="true">13.8.</strong> Utils</a></li></ol></li><li class="chapter-item expanded "><a href="../configuration/index.html"><strong aria-hidden="true">14.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../configuration/generator.html"><strong aria-hidden="true">14.1.</strong> (tool) generator</a></li><li class="chapter-item expanded "><a href="../configuration/api.html"><strong aria-hidden="true">14.2.</strong> api</a></li><li class="chapter-item expanded "><a href="../configuration/command-service.html"><strong aria-hidden="true">14.3.</strong> command-service</a></li><li class="chapter-item expanded "><a href="../configuration/data-router.html"><strong aria-hidden="true">14.4.</strong> data-router</a></li><li class="chapter-item expanded "><a href="../configuration/edge-registry.html"><strong aria-hidden="true">14.5.</strong> edge-registry</a></li><li class="chapter-item expanded "><a href="../configuration/materializer-general.html"><strong aria-hidden="true">14.6.</strong> materializer-general</a></li><li class="chapter-item expanded "><a href="../configuration/materializer-ondemand.html"><strong aria-hidden="true">14.7.</strong> materializer-ondemand</a></li><li class="chapter-item expanded "><a href="../configuration/object-builder.html"><strong aria-hidden="true">14.8.</strong> object-builder</a></li><li class="chapter-item expanded "><a href="../configuration/partial-update-engine.html"><strong aria-hidden="true">14.9.</strong> partial-update-engine</a></li><li class="chapter-item expanded "><a href="../configuration/query-router.html"><strong aria-hidden="true">14.10.</strong> query-router</a></li><li class="chapter-item expanded "><a href="../configuration/query-service.html"><strong aria-hidden="true">14.11.</strong> query-service</a></li><li class="chapter-item expanded "><a href="../configuration/query-service-ts.html"><strong aria-hidden="true">14.12.</strong> query-service-ts</a></li><li class="chapter-item expanded "><a href="../configuration/schema-registry.html"><strong aria-hidden="true">14.13.</strong> schema-registry</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">15.</strong> RFCs</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfc/0022_Materialization_Types_01.html"><strong aria-hidden="true">15.1.</strong> 0022 - Materialization Types</a></li><li class="chapter-item expanded "><a href="../rfc/0021_Custom_Data_Passthrough_01.html"><strong aria-hidden="true">15.2.</strong> 0021 - Custom Data Passthrough</a></li><li class="chapter-item expanded "><a href="../rfc/0020_Configuration_Service_01.html"><strong aria-hidden="true">15.3.</strong> 0020 - Configuration service</a></li><li class="chapter-item expanded "><a href="../rfc/0019_Simplify_Schema_Definitions_01.html"><strong aria-hidden="true">15.4.</strong> 0019 - Simplify Schema Definitions</a></li><li class="chapter-item expanded "><a href="../rfc/0018_Transport_headers_passthrough_01.html"><strong aria-hidden="true">15.5.</strong> 0018 - Transport headers passthrough</a></li><li class="chapter-item expanded "><a href="../rfc/0017_Edge_registry_resolving_relation_trees_01.html"><strong aria-hidden="true">15.6.</strong> 0017 - Edge Registry: Resolving relation trees</a></li><li class="chapter-item expanded "><a href="../rfc/0015_CI_CD_RnD_01.html"><strong aria-hidden="true">15.7.</strong> 0015 - CI/CD setup R&amp;D</a></li><li class="chapter-item expanded "><a href="../rfc/0014_Query_raw_routes_01.html"><strong aria-hidden="true">15.8.</strong> 0014 - Query raw routes</a></li><li class="chapter-item expanded "><a href="../rfc/0013_Documentation_restructure_and_RFC_process_01.html"><strong aria-hidden="true">15.9.</strong> 0013 - Documentation restructure and RFC process</a></li><li class="chapter-item expanded "><a href="../rfc/0012_CDL_documentation_generation_01.html"><strong aria-hidden="true">15.10.</strong> 0012 - CDL Documentation Generation</a></li><li class="chapter-item expanded "><a href="../rfc/0011_Branching_strategy_01.html"><strong aria-hidden="true">15.11.</strong> 0011 - Branching strategy</a></li><li class="chapter-item expanded "><a href="../rfc/0010_Schema_Registry_less_CDL_deployment_01.html"><strong aria-hidden="true">15.12.</strong> 0010 - Schema-Registry-less CDL deployment</a></li><li class="chapter-item expanded "><a href="../rfc/0009_CDL_Ingestion_API_versioning_02.html"><strong aria-hidden="true">15.13.</strong> 0009 - CdlIM Versioning 2.0</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfc/archive/0005_CDL_Ingestion_API_versioning_01.html"><strong aria-hidden="true">15.13.1.</strong> 0005 - CdlIM Versioning</a></li></ol></li><li class="chapter-item expanded "><a href="../rfc/0008_CDL_publishing_deployment_configurations_01.html"><strong aria-hidden="true">15.14.</strong> 0008 - CDL publishing deployment configurations</a></li><li class="chapter-item expanded "><a href="../rfc/0007_Materialized_views_01.html"><strong aria-hidden="true">15.15.</strong> 0007 - Materialized Views</a></li><li class="chapter-item expanded "><a href="../rfc/0006_Edge_registry_01.html"><strong aria-hidden="true">15.16.</strong> 0006 - Edge Registry</a></li><li class="chapter-item expanded "><a href="../rfc/0004_Commit_message_formalization_and_enforcement_01.html"><strong aria-hidden="true">15.17.</strong> 0004 - Commit message formalization</a></li><li class="chapter-item expanded "><a href="../rfc/0003_Usage_of_Message_Pack_format_as_a_CDL_input_01.html"><strong aria-hidden="true">15.18.</strong> 0003 - MessagePack support</a></li><li class="chapter-item expanded "><a href="../rfc/0002_Materialization_01.html"><strong aria-hidden="true">15.19.</strong> 0002 - Materialization - Overview</a></li><li class="chapter-item expanded "><a href="../rfc/0001_Alternative_communication_method_01.html"><strong aria-hidden="true">15.20.</strong> 0001 - Alternative communication method</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Common Data Layer</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/epiphany-platform/CommonDataLayer" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#cdl-performance-testing" id="cdl-performance-testing">CDL Performance Testing</a></h1>
<h2><a class="header" href="#glossary" id="glossary">Glossary</a></h2>
<ul>
<li>Playground - initial deployment, designed for use in CDL development.</li>
<li>KPI - key performance indicator - a quantifiable measurement, often use in long-term statistics.</li>
</ul>
<h2><a class="header" href="#introduction" id="introduction">Introduction</a></h2>
<p>The purpose CDL internal performance testing process is to monitor CDL bottlenecks and allow us to see potential performance issues before they occur on CDL production deployments. Results don't match expected CDL performance in a production environment, as some assumptions done during the testing are not acceptable on production deployments. However, measuring expected CDL performance on a production environment can be done similarly, with some configuration changes(mostly proper production configuration for external services - Postgres, Kafka, etc.).</p>
<h2><a class="header" href="#testing-environment" id="testing-environment">Testing environment</a></h2>
<h4><a class="header" href="#cdl-carrier" id="cdl-carrier">CDL Carrier</a></h4>
<p>Currently there is no production-ready configuration for CDL, kubernetes deployment is an example one, and baremetal deployment hosted via horust (systemd-like management tool) is targeted for development and general testing. For testing purposes, CDL will be deployed on either bare metal servers or virtual ones, using kubernetes management system.</p>
<p>Currently, for the playground, we are quite fine with using kubernetes deployment backed up by helm. We made sure that each service will own at least one cpu core during work, however some tests require at least 2 cores to tests parallel computing solutions, so this should be taken into consideration.</p>
<h4><a class="header" href="#io-sensitive-components" id="io-sensitive-components">IO Sensitive Components</a></h4>
<p>Components sensitive to the hardware configuration will have to receive its own machines, examples of such are the databases (Postgres, VictoriaMetrics, ElasticSearch). Those components will have unrestricted configuration, meaning it does not matter how it is set up on the destination node, however rules mentioned in the <code>Hardware Configuration</code> are still in effect.</p>
<p>In case of our initial deployment on playground, we decided to use Azure, as VM provider, and each of the databases received its own dedicated VM for exclusive usage. To such VM's we attached the dedicated SSD to have stable IO performance readouts.</p>
<h4><a class="header" href="#logging-and-metrics" id="logging-and-metrics">Logging and Metrics</a></h4>
<p>This section is split in two parts: message logging (as error messages or notification) and metrics (as statistics). Both of those systems are crucial for testing CDL properly.</p>
<ul>
<li>Metrics -  we are using Grafana, and as such each component have to expose its basic parameters for collection. Currently, the idea is that during performance testing we will have a separate component that will collect the metrics alongside Grafana and store it per test execution.</li>
<li>Logging - for logging we are using elastic search server. As with the metrics, we are planning for the test-runner to be able to access the logs per test run and check for all issues associated with the run itself, log errors and warnings. Those will also be preserved.</li>
</ul>
<h3><a class="header" href="#hardware-configuration" id="hardware-configuration">Hardware Configuration</a></h3>
<p>Hardware configuration is designed to make the tests as repetitive as possible. As demanding as the testing is, CDL require multiple nodes to perform its computations in stable environment. What it means is:</p>
<ul>
<li>Network configuration is stable and is not changed across tests, that also means that there should not be changes in routing, routing hardware, network adapters, drivers nor topology across multiple tests.</li>
<li>Node (as computing node) should not change its configuration. If there is a software update pending for the node, additional tests have to be run to determine if new software made an impact on tests. This may be especially important for the software that hosts the CDL, i.e.  container management system or dynamic libraries used directly or indirectly in CDL runtime.</li>
<li>IO (as storage devices, hard disks or in worst-case scenario, NFS drives) configuration should be preserved. If hardware needs to be updated or replaced, tests on the same version and configuration of CDL but changed hardware should be done to determine how the new storage device compares to the previously used one.</li>
</ul>
<p>** NOTE: for some components, we may test scalability in the future by adding another mirror node. The node will be on an identical machine (one of the free ones will be reused)</p>
<h3><a class="header" href="#postgres" id="postgres">Postgres</a></h3>
<h4><a class="header" href="#machine" id="machine">Machine</a></h4>
<p>Standard DS3 v2 (4 vcpus, 14 GiB memory)
Additional SSD disk
** NOTE: we may test scalability by adding another mirror node. The node will be on an identical machine (one of the free ones will be reused)</p>
<h4><a class="header" href="#configuration" id="configuration">Configuration</a></h4>
<ul>
<li>Disabled WAL for CDL tables(<code>ALTER TABLE table_name SET UNLOGGED;</code>)</li>
</ul>
<p>** NOTE: We're using the same Postgres database instance for Postgres Repository, Edge Registry, Schema Registry, and Postgres Materializer. **
** This is temporary measure, when testing process is ready we will decide if we need separate posgres instance for those components **</p>
<h3><a class="header" href="#kafka" id="kafka">Kafka</a></h3>
<h4><a class="header" href="#machine-1" id="machine-1">Machine</a></h4>
<p>Standard DS3 v2 (4 vcpus, 14 GiB memory)</p>
<h4><a class="header" href="#configuration-1" id="configuration-1">Configuration</a></h4>
<p>Consumer:</p>
<ul>
<li>No performance related changes</li>
</ul>
<p>Publisher:</p>
<ul>
<li>acks: all</li>
<li>compression.type: none</li>
<li>max.in.flight.requests.per.connection: 1</li>
</ul>
<h3><a class="header" href="#rabbitmq" id="rabbitmq">RabbitMQ</a></h3>
<h4><a class="header" href="#machine-2" id="machine-2">Machine</a></h4>
<p>Standard DS3 v2 (4 vcpus, 14 GiB memory)</p>
<h4><a class="header" href="#configuration-2" id="configuration-2">Configuration</a></h4>
<p>This component is planned but not deployed yet, it will be handled before perofrmance tests start.</p>
<h3><a class="header" href="#victoria-metrics" id="victoria-metrics">Victoria Metrics</a></h3>
<h4><a class="header" href="#machine-3" id="machine-3">Machine</a></h4>
<p>Standard DS3 v2 (4 vcpus, 14 GiB memory)</p>
<h4><a class="header" href="#configuration-3" id="configuration-3">Configuration</a></h4>
<p>This component is planned but not deployed yet, it will be handled before perofrmance tests start.</p>
<h2><a class="header" href="#results-processing" id="results-processing">Results processing</a></h2>
<p>CDL exposes information about runtime performance in form of metrics. They're effortless to use and provide much information to the user. Based on metrics(both CDL internals and Kafka/Postgres/k8s/machines related ones) user can determine what is the bottleneck. For automatic testing(monitoring bottleneck performance) we depend on more basic methods. However, if an automatic test reveals a possible problem, it's worth it for the developer to compare metrics on prometheus/grafana to see what's changed.</p>
<p>We should also check if there were any errors during the testing process. This can be done by checking the numbers of rows inserted/returned by the test after the test is finished. Each, even small mismatch in expected and actual numbers qualify for manual developer review.</p>
<p>We should store the following artifacts from testing:</p>
<ul>
<li>grafana metrics</li>
<li>k8s cluster state (<code>kubectl get pods -o=wide</code>)</li>
<li>CDL logs (only if there were any errors)</li>
<li>dbs state (only if there were any errors)</li>
</ul>
<h2><a class="header" href="#test-focus" id="test-focus">Test Focus</a></h2>
<p>For now, we're testing the following processes. This list will grow over time.</p>
<ul>
<li>Data IO
<ul>
<li>Storage Layer Input</li>
<li>Storage Layer Output</li>
</ul>
</li>
<li>Materialization (WIP)
<ul>
<li>ondemand materialization</li>
<li>general materialization</li>
</ul>
</li>
<li>DB Shrinker</li>
<li>historical data folding (WIP)</li>
</ul>
<h3><a class="header" href="#general-testing-rules" id="general-testing-rules">General testing rules</a></h3>
<ul>
<li>Before running the test, determine if kafka should be empty or pre-fed. Pre-feeding allows the test to help gather information about the component speed. Feeding it in place makes it more focused on real-life scenario.</li>
<li>Test data should be generated once and reused, updated only once CDL input format changes. Generation should not be performed during the test.</li>
<li>Tests should be run in the identical environment.</li>
<li>Tests should be run 10 times, remove 3 results farthest from the rest, average rest to get a single value</li>
</ul>
<h3><a class="header" href="#data-input" id="data-input">Data Input</a></h3>
<p>Test options:</p>
<ul>
<li>average size of inserted messages (focus on the same size all the time)</li>
<li>data size variation (small and big messages mixed in)</li>
<li>message batching</li>
<li>to work around IO write bottleneck, we can use /dev/null as an input connector.</li>
</ul>
<p>Process description:</p>
<ul>
<li>Set up CDL</li>
<li>Add CDL schemas definitions</li>
<li>Start time measurement</li>
<li>Load data from files to Kafka
<ul>
<li>optionally wait for the kafka to ingest everything, before starting the Data Router</li>
</ul>
</li>
<li>wait for CDL to emit either specific number of notifications or last message notification, whatever comes last</li>
<li>Write down results - the time it took to insert data</li>
<li>Check if actual number equals expected number of entries in sql table</li>
</ul>
<h3><a class="header" href="#data-output" id="data-output">Data Output</a></h3>
<p>Test options:</p>
<ul>
<li>average size of objects</li>
<li>number of objects returned in a single request</li>
<li>message fragmentation(number of fragments command service needs to merge before returning final objects)</li>
</ul>
<p>Process description:</p>
<ul>
<li>Set up CDL, including Document Database feeding</li>
<li>Fetch series of records from Query Router</li>
<li>Write down results - responses time</li>
<li>Check if the actual number equals the expected number of returned rows</li>
</ul>
<h3><a class="header" href="#materialization" id="materialization">Materialization</a></h3>
<p>Only on-demand materialization is tested, no database-specific materializers nor partial update engine is tested in those tests as of now(should be added in the future).</p>
<p>Test options:</p>
<ul>
<li>view complexness(simple, with relations, with filtering, with computations)</li>
<li>average size of objects</li>
<li>materializer type(on-demand, Postgres, elastic search)</li>
</ul>
<p>Process description:</p>
<ul>
<li>Set up CDL</li>
<li>Add CDL schemas, relations, views definitions</li>
<li>Load data to SQL(object data, edges)</li>
<li>Fetch data from on-demand materializer</li>
<li>Write down results - response time</li>
<li>Check if the actual number equals the expected number of result entries</li>
</ul>
<h3><a class="header" href="#db-shrinker" id="db-shrinker">DB Shrinker</a></h3>
<p>Test options:</p>
<ul>
<li>average size of objects</li>
<li>different number of fragments per object</li>
</ul>
<p>Process description:</p>
<ul>
<li>Set up CDL</li>
<li>Add CDL schemas definitions</li>
<li>Load data to SQL</li>
<li>Start db shrinker job</li>
<li>Wait for db shrinker job to finish</li>
<li>Write down results - the amount of time db shrinker job was alive</li>
<li>Check if the actual number is equal to the expected number of entries in the SQL table</li>
</ul>
<h1><a class="header" href="#faq" id="faq">FAQ</a></h1>
<ul>
<li>Why not measure latency?
CDL isn't a latency focused system, and measuring latency on a cloud system is a complex topic. Latency can change drastically based on service usage, and that change is not linear(more service traffic in some cases means smaller latency).</li>
<li>Why no scaling testing?
CDL code-related bottlenecks are most likely to show on even simpler CDL deployments. Scaling is a complex topic, and it would make these tests much harder to implement.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../processes/0003_Documentation_structure_and_RFC_process.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../versioning.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../processes/0003_Documentation_structure_and_RFC_process.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../versioning.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
