<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Message ordering - The Common Data Layer</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Common Data Layer</a></li><li class="chapter-item expanded "><a href="../how_it_works.html"><strong aria-hidden="true">2.</strong> How does it work</a></li><li class="chapter-item expanded "><a href="../getting_started.html"><strong aria-hidden="true">3.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../deployment/index.html"><strong aria-hidden="true">4.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/local/index.html"><strong aria-hidden="true">4.1.</strong> Local deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/local/docker-compose.html"><strong aria-hidden="true">4.1.1.</strong> docker-compose</a></li><li class="chapter-item expanded "><a href="../deployment/local/helm.html"><strong aria-hidden="true">4.1.2.</strong> Helm</a></li></ol></li><li class="chapter-item expanded "><a href="../deployment/production/index.html"><strong aria-hidden="true">4.2.</strong> Production-grade deployment</a></li></ol></li><li class="chapter-item expanded "><a href="../schemas_and_views.html"><strong aria-hidden="true">5.</strong> Schemas and Views</a></li><li class="chapter-item expanded "><a href="../examples/index.html"><strong aria-hidden="true">6.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/materialization.html"><strong aria-hidden="true">6.1.</strong> Materialization</a></li></ol></li><li class="chapter-item expanded "><a href="../features/index.html"><strong aria-hidden="true">7.</strong> Features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../features/ordering.html" class="active"><strong aria-hidden="true">7.1.</strong> Message ordering</a></li><li class="chapter-item expanded "><a href="../features/client_routing.html"><strong aria-hidden="true">7.2.</strong> Client routing</a></li></ol></li><li class="chapter-item expanded "><a href="../processes/index.html"><strong aria-hidden="true">8.</strong> Processes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../processes/0001_Commit_message_formalization_and_enforcement.html"><strong aria-hidden="true">8.1.</strong> Commit message formalization and enforcement</a></li><li class="chapter-item expanded "><a href="../processes/0002_Branching_strategy.html"><strong aria-hidden="true">8.2.</strong> Branhing strategy</a></li><li class="chapter-item expanded "><a href="../processes/0003_Documentation_structure_and_RFC_process.html"><strong aria-hidden="true">8.3.</strong> Documentation structure and RFC process</a></li></ol></li><li class="chapter-item expanded "><a href="../versioning.html"><strong aria-hidden="true">9.</strong> Versioning</a></li><li class="chapter-item expanded "><a href="../protocol.html"><strong aria-hidden="true">10.</strong> Protocol schema</a></li><li class="chapter-item expanded "><a href="../benchmarks.html"><strong aria-hidden="true">11.</strong> Benchmarks</a></li><li class="chapter-item expanded "><a href="../architecture/index.html"><strong aria-hidden="true">12.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/management.html"><strong aria-hidden="true">12.1.</strong> Management Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/cli.html"><strong aria-hidden="true">12.1.1.</strong> CLI</a></li><li class="chapter-item expanded "><a href="../architecture/web_admin.html"><strong aria-hidden="true">12.1.2.</strong> Admin Web Panel</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/api.html"><strong aria-hidden="true">12.2.</strong> GraphQL API</a></li><li class="chapter-item expanded "><a href="../architecture/configuration.html"><strong aria-hidden="true">12.3.</strong> Configuration Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/schema_registry.html"><strong aria-hidden="true">12.3.1.</strong> Schema Registry</a></li><li class="chapter-item expanded "><a href="../architecture/leader_elector.html"><strong aria-hidden="true">12.3.2.</strong> Leader Elector</a></li><li class="chapter-item expanded "><a href="../architecture/edge_registry.html"><strong aria-hidden="true">12.3.3.</strong> Edge Registry</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/ingestion.html"><strong aria-hidden="true">12.4.</strong> Ingestion Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/data_router.html"><strong aria-hidden="true">12.4.1.</strong> Data Router</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/storage.html"><strong aria-hidden="true">12.5.</strong> Storage Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/command_service.html"><strong aria-hidden="true">12.5.1.</strong> Command Service</a></li><li class="chapter-item expanded "><a href="../architecture/db_shrinker_storage.html"><strong aria-hidden="true">12.5.2.</strong> Db Shrinker Storage</a></li><li class="chapter-item expanded "><a href="../architecture/query_service.html"><strong aria-hidden="true">12.5.3.</strong> Query Service</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.6.</strong> Materialization Layer</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/object_builder.html"><strong aria-hidden="true">12.6.1.</strong> Object Builder</a></li><li class="chapter-item expanded "><a href="../architecture/partial_update_engine.html"><strong aria-hidden="true">12.6.2.</strong> Partial Update Engine</a></li><li class="chapter-item expanded "><a href="../architecture/materializer_general.html"><strong aria-hidden="true">12.6.3.</strong> General Materializer</a></li><li class="chapter-item expanded "><a href="../architecture/materializer_ondemand.html"><strong aria-hidden="true">12.6.4.</strong> On Demand Materializer</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/retrieval.html"><strong aria-hidden="true">12.7.</strong> Retrieval Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/query_router.html"><strong aria-hidden="true">12.7.1.</strong> Query Router</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/utils.html"><strong aria-hidden="true">12.8.</strong> Utils</a></li></ol></li><li class="chapter-item expanded "><a href="../configuration/index.html"><strong aria-hidden="true">13.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../configuration/generator.html"><strong aria-hidden="true">13.1.</strong> (tool) generator</a></li><li class="chapter-item expanded "><a href="../configuration/api.html"><strong aria-hidden="true">13.2.</strong> api</a></li><li class="chapter-item expanded "><a href="../configuration/command-service.html"><strong aria-hidden="true">13.3.</strong> command-service</a></li><li class="chapter-item expanded "><a href="../configuration/data-router.html"><strong aria-hidden="true">13.4.</strong> data-router</a></li><li class="chapter-item expanded "><a href="../configuration/edge-registry.html"><strong aria-hidden="true">13.5.</strong> edge-registry</a></li><li class="chapter-item expanded "><a href="../configuration/materializer-general.html"><strong aria-hidden="true">13.6.</strong> materializer-general</a></li><li class="chapter-item expanded "><a href="../configuration/materializer-ondemand.html"><strong aria-hidden="true">13.7.</strong> materializer-ondemand</a></li><li class="chapter-item expanded "><a href="../configuration/object-builder.html"><strong aria-hidden="true">13.8.</strong> object-builder</a></li><li class="chapter-item expanded "><a href="../configuration/partial-update-engine.html"><strong aria-hidden="true">13.9.</strong> partial-update-engine</a></li><li class="chapter-item expanded "><a href="../configuration/query-router.html"><strong aria-hidden="true">13.10.</strong> query-router</a></li><li class="chapter-item expanded "><a href="../configuration/query-service.html"><strong aria-hidden="true">13.11.</strong> query-service</a></li><li class="chapter-item expanded "><a href="../configuration/query-service-ts.html"><strong aria-hidden="true">13.12.</strong> query-service-ts</a></li><li class="chapter-item expanded "><a href="../configuration/schema-registry.html"><strong aria-hidden="true">13.13.</strong> schema-registry</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> RFCs</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">14.1.</strong> 0021 - Development process</div></li><li class="chapter-item expanded "><a href="../rfc/0020_Configuration_Service_01.html"><strong aria-hidden="true">14.2.</strong> 0020 - Configuration service</a></li><li class="chapter-item expanded "><a href="../rfc/0019_Simplify_Schema_Definitions_01.html"><strong aria-hidden="true">14.3.</strong> 0019 - Simplify Schema Definitions</a></li><li class="chapter-item expanded "><a href="../rfc/0018_Transport_headers_passthrough_01.html"><strong aria-hidden="true">14.4.</strong> 0018 - Transport headers passthrough</a></li><li class="chapter-item expanded "><a href="../rfc/0017_Edge_registry_resolving_relation_trees_01.html"><strong aria-hidden="true">14.5.</strong> 0017 - Edge Registry: Resolving relation trees</a></li><li class="chapter-item expanded "><a href="../rfc/0015_CI_CD_RnD.html"><strong aria-hidden="true">14.6.</strong> 0015 - CI/CD setup R&amp;D</a></li><li class="chapter-item expanded "><a href="../rfc/0014_Query_raw_routes_01.html"><strong aria-hidden="true">14.7.</strong> 0014 - Query raw routes</a></li><li class="chapter-item expanded "><a href="../rfc/0013_Documentation_restructure_and_RFC_process_01.html"><strong aria-hidden="true">14.8.</strong> 0013 - Documentation restructure and RFC process</a></li><li class="chapter-item expanded "><a href="../rfc/0012_CDL_documentation_generation_01.html"><strong aria-hidden="true">14.9.</strong> 0012 - CDL Documentation Generation</a></li><li class="chapter-item expanded "><a href="../rfc/0011_Branching_strategy_01.html"><strong aria-hidden="true">14.10.</strong> 0011 - Branching strategy</a></li><li class="chapter-item expanded "><a href="../rfc/0010_Schema_Registry_less_CDL_deployment_01.html"><strong aria-hidden="true">14.11.</strong> 0010 - Schema-Registry-less CDL deployment</a></li><li class="chapter-item expanded "><a href="../rfc/0008_CDL_publishing_deployment_configurations_01.html"><strong aria-hidden="true">14.12.</strong> 0008 - CDL publishing deployment configurations</a></li><li class="chapter-item expanded "><a href="../rfc/0009_CDL_Ingestion_API_versioning_02.html"><strong aria-hidden="true">14.13.</strong> 0009 - CdlIM Versioning 2.0</a></li><li class="chapter-item expanded "><a href="../rfc/0007_Materialized_views_01.html"><strong aria-hidden="true">14.14.</strong> 0007 - Materialized Views</a></li><li class="chapter-item expanded "><a href="../rfc/0006_Edge_registry_01.html"><strong aria-hidden="true">14.15.</strong> 0006 - Edge Registry</a></li><li class="chapter-item expanded "><a href="../rfc/0005_CDL_Ingestion_API_versioning_01.html"><strong aria-hidden="true">14.16.</strong> 0005 - CdlIM Versioning</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfc/0009_CDL_Ingestion_API_versioning_02.html"><strong aria-hidden="true">14.16.1.</strong> 0009 - CdlIM Versioning 2.0</a></li></ol></li><li class="chapter-item expanded "><a href="../rfc/0004_Commit_message_formalization_and_enforcement_01.html"><strong aria-hidden="true">14.17.</strong> 0004 - Commit message formalization</a></li><li class="chapter-item expanded "><a href="../rfc/0003_Usage_of_Message_Pack_format_as_CDL_input_01.html"><strong aria-hidden="true">14.18.</strong> 0003 - MessagePack support</a></li><li class="chapter-item expanded "><a href="../rfc/0002_Materialization_01.html"><strong aria-hidden="true">14.19.</strong> 0002 - Materialization - Overview</a></li><li class="chapter-item expanded "><a href="../rfc/0001_Alternative_communication_method_01.html"><strong aria-hidden="true">14.20.</strong> 0001 - Alternative communication method</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Common Data Layer</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/epiphany-platform/CommonDataLayer" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#message-ordering" id="message-ordering">Message ordering</a></h1>
<h2><a class="header" href="#index" id="index">Index</a></h2>
<ul>
<li><a href="#what_is">What is message ordering</a></li>
<li><a href="#why">Why does it matter</a>
<ul>
<li><a href="#soccer">Football/soccer game</a></li>
<li><a href="#trafic_monitor">Network traffic monitor</a></li>
<li><a href="#pros">Pros and cons</a></li>
</ul>
</li>
<li><a href="#message_ordering_in_cdl">Message ordering in CDL</a></li>
<li><a href="#how_to_use">How to use it</a>
<ul>
<li><a href="#overall">Overall</a></li>
<li><a href="#kafka">Communication through Apache Kafka</a></li>
<li><a href="#rabbit">Communication through RabbitMQ</a></li>
<li><a href="#rpc">Communication through RPC</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#a-namewhat_isawhat-is-message-ordering" id="a-namewhat_isawhat-is-message-ordering"><a name="what_is"></a>What is message ordering</a></h2>
<p>Message ordering is a guarantee that certain messages will be processed by CDL in the same order there were sent to the system. Proper ordering matter mostly to user applications which base their business logic on real-time data where no approximation is allowed. </p>
<h2><a class="header" href="#a-namewhyawhy-does-it-matter" id="a-namewhyawhy-does-it-matter"><a name="why"></a>Why does it matter</a></h2>
<p>Let's consider two use cases which will show us why order of received messages might/might not matter: </p>
<h3><a class="header" href="#a-namesoccerafootballsoccer-game" id="a-namesoccerafootballsoccer-game"><a name="soccer"></a>Football/soccer game</a></h3>
<p>We develop an application which decides strategy for playing football matches. Based on actual score we decide if our team should play more offensively, defensively or utilize balanced play style. </p>
<p>Incoming events: </p>
<ul>
<li>(1) Match start </li>
<li>(2) We scored a goal </li>
<li>(3) Enemy scored a goal </li>
<li>(4) Match end </li>
</ul>
<p>Linearizable system (system which can establish exact order for each message), will see events in the order they were produced. Our application will start game with balanced play style, go defense after 2nd event is received (we scored a goal) and change it back to balanced once enemy hits us back. </p>
<p>Without proper message ordering same situation can be processed (seen by clients) differently. If second message got delayed for some reason and came out of order, we could play with completely different strategy. We would start game in balanced formation, then the 3rd message will show up (enemy scored a goal), so we'll think we're losing the game and start playing offensively. After some time, 2nd message will finally show up and we'll end game in balanced formation. </p>
<p>From user perspective it would seem that our program is broken because we played more offensively once we were one point ahead of the enemy, which could cause us to lose our advantage. </p>
<p>It's worth noting that if we play other sport discipline e.g., a basketball or volleyball making decisions with few delayed messages can be considered valid behavior - there are more data points, so it would be fine to use approximated score (difference of one or two points doesn't change the general strategy because there are much more points in general). In such case we don't make our decision based on loosing single point but make it if we're losing by a few points. Loosing single point (single message) has a small impact on our decision-making process. </p>
<h3><a class="header" href="#a-nametrafic_monitoranetwork-traffic-monitor" id="a-nametrafic_monitoranetwork-traffic-monitor"><a name="trafic_monitor"></a>Network traffic monitor</a></h3>
<p>We develop an application which measure network traffic. It can show different statistics per chosen period. </p>
<p>We're looking for statistics, so it's often fine to approximate the data. We mostly do our job on many data points at once (time period) so even skipping some of them would mostly be fine. What is also important is the fact that we're not processing a real-time data - we're showing data from some time ago (a month, an hour etc.), so even if messages come in the wrong order, they will be available in the system once we query them. </p>
<p>In this case message ordering is not that important. We're using historical data which will be correct regardless of message ordering.</p>
<h3><a class="header" href="#a-nameprosapros" id="a-nameprosapros"><a name="pros"></a>Pros</a></h3>
<ul>
<li>without message ordering system might see a state of things that have never happened (not just delayed state) </li>
</ul>
<h3><a class="header" href="#a-nameconsacons" id="a-nameconsacons"><a name="cons"></a>Cons</a></h3>
<ul>
<li>fully linearizable systems can be really slow - inerrability drastically limits system ability to process data in parallel (and scale horizontally) </li>
</ul>
<h2><a class="header" href="#a-namemessage_ordering_in_cdlamessage-ordering-in-cdl" id="a-namemessage_ordering_in_cdlamessage-ordering-in-cdl"><a name="message_ordering_in_cdl"></a>Message ordering in CDL</a></h2>
<p>CDL supports three message ordering strategies: </p>
<ul>
<li>Fully ordered messages(linearizable) </li>
<li>Message ordering defined by causality </li>
<li>Unordered messages (no message ordering guarantees) </li>
</ul>
<p>Message ordering defined by causality is a middle ground between two opposite strategies. It allows you to keep message ordering for some of the messages without performance costs of full linearization. E.g., in our first example we could say that order of messages regarding same game is important, but we don't care about order of two messages related to different sport events. </p>
<h2><a class="header" href="#a-namehow_to_useahow-to-use-it" id="a-namehow_to_useahow-to-use-it"><a name="how_to_use"></a>How to use it</a></h2>
<h3><a class="header" href="#a-nameoverallaoverall" id="a-nameoverallaoverall"><a name="overall"></a>Overall</a></h3>
<p>In CDL message ordering guarantees are defined on per message level. In CDL data ingestion message format there is an optional field called <code>order_group_id</code>. This field should contain user generated UUID with ordering info. If you set this value CDL guarantees that messages with the same <code>order_group_id</code> will be processed in the order they were send to CDL. Otherwise, if field is left empty, no ordering guarantees are met for this message. This behavior allows us to support causality ordering (multiple <code>order_group_id</code> values), linearizability (same <code>order_group_id</code> for each message) or to skip ordering guarantees at all(<code>ordering_group_id</code> not provided). </p>
<h3><a class="header" href="#a-namekafkaacommunication-through-apache-kafka" id="a-namekafkaacommunication-through-apache-kafka"><a name="kafka"></a>Communication through Apache Kafka</a></h3>
<p>If you’re using Kafka as a message bus following requirements needs to be met for message ordering to work correctly: </p>
<ul>
<li>Kafka partitioning should be based on message key </li>
<li>Message keys of data coming to CDL should be set to <code>order_group_id</code> or left empty if message order is not important</li>
<li>Scaling data router and command service is possible up to number of Kafka partitions. If you need more service instances you must have enough Kafka partitions to feed them messages. </li>
</ul>
<h3><a class="header" href="#a-namerabbitacommunication-through-rabbitmq" id="a-namerabbitacommunication-through-rabbitmq"><a name="rabbit"></a>Communication through RabbitMQ</a></h3>
<p>If you’re using RabbitMQ as a message bus following requirements needs to be met for message ordering to work correctly: </p>
<ul>
<li>You must create proper exchange-queue bindings in RabbitMQ 
<ul>
<li>create 2+ queues - one for unordered messages, one or more for ordered ones; number of queues is the limit of horizontal instance scaling (exception - unordered messages) </li>
<li>create one exchange which name will be saved in schema registry</li>
<li>create binding between exchange and queues in a way that messages with <code>unordered</code> message key will go to queues with unordered data, other keys will be split between other queues </li>
</ul>
</li>
<li>Configure command service instances: 
<ul>
<li>Unordered message queue can be passed to each command service instance </li>
<li>Ordered message queue can be passed to single command service (exclusive consumer) </li>
</ul>
</li>
<li>Message keys of data coming to CDL should be set to <code>order_group_id</code> or left empty if message order is not important</li>
</ul>
<p>Unfortunately, that means that scaling command services can be done only manually (automatic scaling may be implemented by <a href="https://github.com/epiphany-platform/CommonDataLayer/issues/185">#185</a>), instances which process only unordered messages can be scaled automatically. </p>
<h3><a class="header" href="#a-namerpcacommunication-through-rpcwip" id="a-namerpcacommunication-through-rpcwip"><a name="rpc"></a>Communication through RPC(WIP)</a></h3>
<p>In case of communication through RPC message ordering is guaranteed by request/response pattern and its client responsibility to decide if messages can be sent (and processed) in parallel. <code>order_group_id</code> field is ignored. </p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../features/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../features/client_routing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../features/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../features/client_routing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
