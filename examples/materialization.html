<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Materialization - The Common Data Layer</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Common Data Layer</a></li><li class="chapter-item expanded "><a href="../how_it_works.html"><strong aria-hidden="true">2.</strong> How does it work</a></li><li class="chapter-item expanded "><a href="../getting_started.html"><strong aria-hidden="true">3.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../deployment/index.html"><strong aria-hidden="true">4.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/local/index.html"><strong aria-hidden="true">4.1.</strong> Local deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/local/docker-compose.html"><strong aria-hidden="true">4.1.1.</strong> docker-compose</a></li><li class="chapter-item expanded "><a href="../deployment/local/helm.html"><strong aria-hidden="true">4.1.2.</strong> Helm</a></li></ol></li><li class="chapter-item expanded "><a href="../deployment/production/index.html"><strong aria-hidden="true">4.2.</strong> Production-grade deployment</a></li></ol></li><li class="chapter-item expanded "><a href="../schemas_and_views.html"><strong aria-hidden="true">5.</strong> Schemas and Views</a></li><li class="chapter-item expanded "><a href="../examples/index.html"><strong aria-hidden="true">6.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/materialization.html" class="active"><strong aria-hidden="true">6.1.</strong> Materialization</a></li></ol></li><li class="chapter-item expanded "><a href="../features/index.html"><strong aria-hidden="true">7.</strong> Features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../features/ordering.html"><strong aria-hidden="true">7.1.</strong> Message ordering</a></li><li class="chapter-item expanded "><a href="../features/client_routing.html"><strong aria-hidden="true">7.2.</strong> Client routing</a></li></ol></li><li class="chapter-item expanded "><a href="../processes/index.html"><strong aria-hidden="true">8.</strong> Processes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../processes/0001_Commit_message_formalization_and_enforcement.html"><strong aria-hidden="true">8.1.</strong> Commit message formalization and enforcement</a></li><li class="chapter-item expanded "><a href="../processes/0002_Branching_strategy.html"><strong aria-hidden="true">8.2.</strong> Branhing strategy</a></li><li class="chapter-item expanded "><a href="../processes/0003_Documentation_structure_and_RFC_process.html"><strong aria-hidden="true">8.3.</strong> Documentation structure and RFC process</a></li><li class="chapter-item expanded "><a href="../processes/0004_Internal_performance_testing.html"><strong aria-hidden="true">8.4.</strong> CDL Performance Testing</a></li></ol></li><li class="chapter-item expanded "><a href="../versioning.html"><strong aria-hidden="true">9.</strong> Versioning</a></li><li class="chapter-item expanded "><a href="../stability.html"><strong aria-hidden="true">10.</strong> Stability</a></li><li class="chapter-item expanded "><a href="../protocol.html"><strong aria-hidden="true">11.</strong> Protocol schema</a></li><li class="chapter-item expanded "><a href="../benchmarks.html"><strong aria-hidden="true">12.</strong> Benchmarks</a></li><li class="chapter-item expanded "><a href="../architecture/index.html"><strong aria-hidden="true">13.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/management.html"><strong aria-hidden="true">13.1.</strong> Management Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/cli.html"><strong aria-hidden="true">13.1.1.</strong> CLI</a></li><li class="chapter-item expanded "><a href="../architecture/web_admin.html"><strong aria-hidden="true">13.1.2.</strong> Admin Web Panel</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/api.html"><strong aria-hidden="true">13.2.</strong> GraphQL API</a></li><li class="chapter-item expanded "><a href="../architecture/configuration.html"><strong aria-hidden="true">13.3.</strong> Configuration Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/schema_registry.html"><strong aria-hidden="true">13.3.1.</strong> Schema Registry</a></li><li class="chapter-item expanded "><a href="../architecture/leader_elector.html"><strong aria-hidden="true">13.3.2.</strong> Leader Elector</a></li><li class="chapter-item expanded "><a href="../architecture/edge_registry.html"><strong aria-hidden="true">13.3.3.</strong> Edge Registry</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/ingestion.html"><strong aria-hidden="true">13.4.</strong> Ingestion Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/data_router.html"><strong aria-hidden="true">13.4.1.</strong> Data Router</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/storage.html"><strong aria-hidden="true">13.5.</strong> Storage Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/command_service.html"><strong aria-hidden="true">13.5.1.</strong> Command Service</a></li><li class="chapter-item expanded "><a href="../architecture/db_shrinker_storage.html"><strong aria-hidden="true">13.5.2.</strong> Db Shrinker Storage</a></li><li class="chapter-item expanded "><a href="../architecture/query_service.html"><strong aria-hidden="true">13.5.3.</strong> Query Service</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.6.</strong> Materialization Layer</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/object_builder.html"><strong aria-hidden="true">13.6.1.</strong> Object Builder</a></li><li class="chapter-item expanded "><a href="../architecture/partial_update_engine.html"><strong aria-hidden="true">13.6.2.</strong> Partial Update Engine</a></li><li class="chapter-item expanded "><a href="../architecture/materializer_general.html"><strong aria-hidden="true">13.6.3.</strong> General Materializer</a></li><li class="chapter-item expanded "><a href="../architecture/materializer_ondemand.html"><strong aria-hidden="true">13.6.4.</strong> On Demand Materializer</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/retrieval.html"><strong aria-hidden="true">13.7.</strong> Retrieval Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/query_router.html"><strong aria-hidden="true">13.7.1.</strong> Query Router</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/utils.html"><strong aria-hidden="true">13.8.</strong> Utils</a></li></ol></li><li class="chapter-item expanded "><a href="../configuration/index.html"><strong aria-hidden="true">14.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../configuration/generator.html"><strong aria-hidden="true">14.1.</strong> (tool) generator</a></li><li class="chapter-item expanded "><a href="../configuration/api.html"><strong aria-hidden="true">14.2.</strong> api</a></li><li class="chapter-item expanded "><a href="../configuration/command-service.html"><strong aria-hidden="true">14.3.</strong> command-service</a></li><li class="chapter-item expanded "><a href="../configuration/data-router.html"><strong aria-hidden="true">14.4.</strong> data-router</a></li><li class="chapter-item expanded "><a href="../configuration/edge-registry.html"><strong aria-hidden="true">14.5.</strong> edge-registry</a></li><li class="chapter-item expanded "><a href="../configuration/materializer-general.html"><strong aria-hidden="true">14.6.</strong> materializer-general</a></li><li class="chapter-item expanded "><a href="../configuration/materializer-ondemand.html"><strong aria-hidden="true">14.7.</strong> materializer-ondemand</a></li><li class="chapter-item expanded "><a href="../configuration/object-builder.html"><strong aria-hidden="true">14.8.</strong> object-builder</a></li><li class="chapter-item expanded "><a href="../configuration/partial-update-engine.html"><strong aria-hidden="true">14.9.</strong> partial-update-engine</a></li><li class="chapter-item expanded "><a href="../configuration/query-router.html"><strong aria-hidden="true">14.10.</strong> query-router</a></li><li class="chapter-item expanded "><a href="../configuration/query-service.html"><strong aria-hidden="true">14.11.</strong> query-service</a></li><li class="chapter-item expanded "><a href="../configuration/query-service-ts.html"><strong aria-hidden="true">14.12.</strong> query-service-ts</a></li><li class="chapter-item expanded "><a href="../configuration/schema-registry.html"><strong aria-hidden="true">14.13.</strong> schema-registry</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">15.</strong> RFCs</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfc/0022_Materialization_Types_01.html"><strong aria-hidden="true">15.1.</strong> 0022 - Materialization Types</a></li><li class="chapter-item expanded "><a href="../rfc/0021_Custom_Data_Passthrough_01.html"><strong aria-hidden="true">15.2.</strong> 0021 - Custom Data Passthrough</a></li><li class="chapter-item expanded "><a href="../rfc/0020_Configuration_Service_01.html"><strong aria-hidden="true">15.3.</strong> 0020 - Configuration service</a></li><li class="chapter-item expanded "><a href="../rfc/0019_Simplify_Schema_Definitions_01.html"><strong aria-hidden="true">15.4.</strong> 0019 - Simplify Schema Definitions</a></li><li class="chapter-item expanded "><a href="../rfc/0018_Transport_headers_passthrough_01.html"><strong aria-hidden="true">15.5.</strong> 0018 - Transport headers passthrough</a></li><li class="chapter-item expanded "><a href="../rfc/0017_Edge_registry_resolving_relation_trees_01.html"><strong aria-hidden="true">15.6.</strong> 0017 - Edge Registry: Resolving relation trees</a></li><li class="chapter-item expanded "><a href="../rfc/0015_CI_CD_RnD_01.html"><strong aria-hidden="true">15.7.</strong> 0015 - CI/CD setup R&amp;D</a></li><li class="chapter-item expanded "><a href="../rfc/0014_Query_raw_routes_01.html"><strong aria-hidden="true">15.8.</strong> 0014 - Query raw routes</a></li><li class="chapter-item expanded "><a href="../rfc/0013_Documentation_restructure_and_RFC_process_01.html"><strong aria-hidden="true">15.9.</strong> 0013 - Documentation restructure and RFC process</a></li><li class="chapter-item expanded "><a href="../rfc/0012_CDL_documentation_generation_01.html"><strong aria-hidden="true">15.10.</strong> 0012 - CDL Documentation Generation</a></li><li class="chapter-item expanded "><a href="../rfc/0011_Branching_strategy_01.html"><strong aria-hidden="true">15.11.</strong> 0011 - Branching strategy</a></li><li class="chapter-item expanded "><a href="../rfc/0010_Schema_Registry_less_CDL_deployment_01.html"><strong aria-hidden="true">15.12.</strong> 0010 - Schema-Registry-less CDL deployment</a></li><li class="chapter-item expanded "><a href="../rfc/0009_CDL_Ingestion_API_versioning_02.html"><strong aria-hidden="true">15.13.</strong> 0009 - CdlIM Versioning 2.0</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfc/archive/0005_CDL_Ingestion_API_versioning_01.html"><strong aria-hidden="true">15.13.1.</strong> 0005 - CdlIM Versioning</a></li></ol></li><li class="chapter-item expanded "><a href="../rfc/0008_CDL_publishing_deployment_configurations_01.html"><strong aria-hidden="true">15.14.</strong> 0008 - CDL publishing deployment configurations</a></li><li class="chapter-item expanded "><a href="../rfc/0007_Materialized_views_01.html"><strong aria-hidden="true">15.15.</strong> 0007 - Materialized Views</a></li><li class="chapter-item expanded "><a href="../rfc/0006_Edge_registry_01.html"><strong aria-hidden="true">15.16.</strong> 0006 - Edge Registry</a></li><li class="chapter-item expanded "><a href="../rfc/0004_Commit_message_formalization_and_enforcement_01.html"><strong aria-hidden="true">15.17.</strong> 0004 - Commit message formalization</a></li><li class="chapter-item expanded "><a href="../rfc/0003_Usage_of_Message_Pack_format_as_a_CDL_input_01.html"><strong aria-hidden="true">15.18.</strong> 0003 - MessagePack support</a></li><li class="chapter-item expanded "><a href="../rfc/0002_Materialization_01.html"><strong aria-hidden="true">15.19.</strong> 0002 - Materialization - Overview</a></li><li class="chapter-item expanded "><a href="../rfc/0001_Alternative_communication_method_01.html"><strong aria-hidden="true">15.20.</strong> 0001 - Alternative communication method</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Common Data Layer</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/epiphany-platform/CommonDataLayer" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#tutorial-how-to-materialize-data-in-cdl" id="tutorial-how-to-materialize-data-in-cdl">Tutorial: How to materialize data in CDL</a></h1>
<p>Tools used:</p>
<ul>
<li>GNU/Linux system</li>
<li><code>docker</code> and <code>docker-compose</code> - for running dependencies</li>
<li><a href="https://github.com/FedericoPonzi/Horust"><code>horust</code></a> for running CDL locally</li>
<li>any gRPC client (either custom-made or generic like <a href="https://github.com/uw-labs/bloomrpc">BloomRPC</a>) - for communication with schema registry.</li>
<li><code>python3</code> - for pushing data to kafka topic </li>
<li><code>psql</code> - for checking materialized data in Postgres</li>
<li>web browser - for checking Jaeger traces &amp; graphQL interactive API.</li>
</ul>
<h3><a class="header" href="#preparing-environment" id="preparing-environment">Preparing environment</a></h3>
<p>The easiest way to setup an environment is to use <a href="https://github.com/epiphany-platform/CommonDataLayer-deployment">Common Data Layer deployment repository</a>.</p>
<p>You can use one of the examples provided there to run everything with one command.</p>
<h3><a class="header" href="#setup" id="setup">Setup</a></h3>
<p>To materialize view one needs proper setup.</p>
<p>Firstly, system needs schema which informs where store data (for example in document storage like Postgres).
Secondly, it needs view definition which informs what fields are necessary and from which schema it should take it. It also defines where to put materialized data.</p>
<p>During this tutorial we are going to introduce several ways of inserting and mutating state of CDL. One of them (graphQL) is designed only for managament and test purposes.
However, it is the easiest way to quickly manually test the materialization pipeline.</p>
<h4><a class="header" href="#a-manual-setup" id="a-manual-setup">A) Manual setup</a></h4>
<p>Most common and production-like way to setup is by sending requests to schema registry.</p>
<h5><a class="header" href="#adding-new-schema" id="adding-new-schema">Adding new schema</a></h5>
<h6><a class="header" href="#a-grpc-api" id="a-grpc-api">A) gRPC API</a></h6>
<p>To add new schema we need to load schema_registry.proto to our client. In this tutorial we are going to use BloomRPC.</p>
<p>All proto files are stored in <code>crates/rpc/proto</code> directory.</p>
<p>In proto file we can see that message <code>NewSchema</code> uses <code>bytes</code> as a definition.
In bloomRPC it means we need to encode our json definition in base 64:</p>
<p>Schema definition:</p>
<pre><code class="language-json">{
    &quot;name&quot;: &quot;string&quot;
} 
</code></pre>
<p>Encoded:</p>
<pre><code class="language-base64">ewogICAgIm5hbWUiOiAic3RyaW5nIgp9
</code></pre>
<p>Usually schema registry API is available at <a href="http://localhost:50101">http://localhost:50101</a>.</p>
<p>RPC request (<code>schema_registry.SchemaRegistry.AddSchema</code>):</p>
<pre><code class="language-json">{
    &quot;metadata&quot;: {
        &quot;name&quot;: &quot;tutorial-schema&quot;,
        &quot;insert_destination&quot;: &quot;cdl.document.1.data&quot;,
        &quot;query_address&quot;: &quot;http://localhost:50201&quot;,
        &quot;schema_type&quot;: 2
    },
    &quot;definition&quot;: &quot;ewogICAgIm5hbWUiOiAic3RyaW5nIgp9&quot;
} 
</code></pre>
<p>RPC response:</p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;22c8ac58-155e-4643-ab44-42e96dbb88c7&quot;
} 
</code></pre>
<p>Lets save this UUID for later. It is <code>schema_id</code>.</p>
<h6><a class="header" href="#b-graphql-api-management-and-test-purposes-only" id="b-graphql-api-management-and-test-purposes-only">B) graphQL API (management and test purposes only)</a></h6>
<p>Instead of using gRPC we can also leverage graphQL Gateway API to manage all schemas:
An easy to use interface is available at <a href="http://localhost:50106/graphiql">http://localhost:50106/graphiql</a></p>
<p>Mutation request:</p>
<pre><code class="language-graphql">mutation addSchema {
    addSchema(new: {
        insertDestination: &quot;cdl.document.1.data&quot;,
        name: &quot;tutorial-schema&quot;,
        queryAddress: &quot;http://localhost:50201&quot;,
        type: DOCUMENT_STORAGE,
        definition: {
            name: &quot;string&quot;
        }
    }) { id }
}
</code></pre>
<p>As you can see it does not require encoding definition, and it can return all schema metadata, therefore we filter it to retrieve only <code>schema_id</code>.</p>
<h5><a class="header" href="#adding-new-view" id="adding-new-view">Adding new view</a></h5>
<p>Next we need to add new view definition.</p>
<h6><a class="header" href="#a-grpc-api-1" id="a-grpc-api-1">A) gRPC API</a></h6>
<p>gRPC request (<code>schema_registry.SchemaRegistry.AddViewToSchema</code>):</p>
<pre><code class="language-json">{
  &quot;schema_id&quot;: &quot;22c8ac58-155e-4643-ab44-42e96dbb88c7&quot;,
  &quot;name&quot;: &quot;tutorial-view&quot;,
  &quot;materializer_address&quot;: &quot;http://localhost:50203&quot;,
  &quot;materializer_options&quot;: &quot;{\&quot;table\&quot;: \&quot;MATERIALIZED_VIEW\&quot;}&quot;,
  &quot;fields&quot;: {
    &quot;worker_name&quot;: &quot;{ \&quot;field_name\&quot;: \&quot;name\&quot; }&quot;
  }
}
</code></pre>
<p>As you can see this time <code>materializer_options</code> are not using <code>bytes</code> format but are encoded in the string.</p>
<p>See <a href="https://github.com/epiphany-platform/CommonDataLayer/issues/442">Issue #442</a>.</p>
<p>gRPC response:</p>
<pre><code class="language-json">{
  &quot;id&quot;: &quot;ddfc1f23-7b13-4d8e-b8ab-1def8eb30a4e&quot;
}
</code></pre>
<p>This is the <code>view_id</code>.</p>
<h6><a class="header" href="#b-graphql-api-management-and-test-purposes-only-1" id="b-graphql-api-management-and-test-purposes-only-1">B) graphQL API (management and test purposes only)</a></h6>
<p>Mutation request:</p>
<pre><code class="language-graphql">mutation addView{
  addView(schemaId: &quot;22c8ac58-155e-4643-ab44-42e96dbb88c7&quot;, newView: {
    name: &quot;tutorial-view&quot;,
    materializerAddress: &quot;http://localhost:50203&quot;,
    materializerOptions: {
      table: &quot;MATERIALIZED_VIEW&quot;
    },
    fields: {
      worker_name: {
        field_name: &quot;name&quot;
      }
    }
  }) {
    id
  }
}
</code></pre>
<h4><a class="header" href="#b-loading-initial-schema" id="b-loading-initial-schema">B) Loading initial schema</a></h4>
<p>While manual setup is fine for one-time test, it quickly becomes mundane work.
To mitigate this problem, we created a solution to pre-populate schema registry.</p>
<p>In fact, <a href="https://github.com/epiphany-platform/CommonDataLayer-deployment">Common Data Layer deployment repository</a> already contains <a href="https://github.com/epiphany-platform/CommonDataLayer-deployment/blob/develop/bare/setup/schema-registry/initial-schema.kafka.json"><code>bare/setup/schema-registry/initial-schema.kafka.json</code></a> which describes what views and schemas should be inserted on startup.</p>
<h3><a class="header" href="#inserting-data" id="inserting-data">Inserting data</a></h3>
<p>To materialize data first we need to insert it to the CDL.</p>
<h4><a class="header" href="#a-python-script" id="a-python-script">A) Python script</a></h4>
<p>For that purpose we can write very simple Python script:</p>
<pre><code class="language-python">from kafka import KafkaProducer
from kafka.errors import KafkaError

producer = KafkaProducer(bootstrap_servers=['localhost:9092'])

with open('data.json', rb) as binary_file:
    data = binary_file.read()
    future = producer.send('cdl.data.input', data)
    
    try:
        record_metadata = future.get(timeout=10)
    except KafkaError:
        log.exception()
        pass
        
    print (record_metadata.topic)
    print (record_metadata.partition)
    print (record_metadata.offset)
</code></pre>
<p><code>data.json</code> should look like:</p>
<pre><code class="language-json">[
    {
        &quot;objectId&quot;: &quot;dc8cc976-412b-11eb-8000-100000000000&quot;,
        &quot;schemaId&quot;: &quot;22c8ac58-155e-4643-ab44-42e96dbb88c7&quot;,
        &quot;data&quot;: { &quot;name&quot;: &quot;John&quot; }
    },
    {
        &quot;objectId&quot;: &quot;dc8cc976-412b-11eb-8000-000000000000&quot;,
        &quot;schemaId&quot;: &quot;22c8ac58-155e-4643-ab44-42e96dbb88c7&quot;,
        &quot;payload&quot;: { &quot;name&quot;: &quot;Alice&quot; }
    }
]
</code></pre>
<h4><a class="header" href="#b-graphql-api-management-and-test-purposes-only-2" id="b-graphql-api-management-and-test-purposes-only-2">B) graphQL API (management and test purposes only)</a></h4>
<p>graphQL request:</p>
<pre><code class="language-graphql">mutation insertBatch {
  insertBatch(
    messages: [
      {
        objectId: &quot;dc8cc976-412b-11eb-8000-100000000000&quot;,
        schemaId: &quot;22c8ac58-155e-4643-ab44-42e96dbb88c7&quot;,
        payload: { name: &quot;John&quot; }
      }
      {
        objectId: &quot;dc8cc976-412b-11eb-8000-000000000000&quot;,
        schemaId: &quot;22c8ac58-155e-4643-ab44-42e96dbb88c7&quot;,
        payload: { name: &quot;Alice&quot; }
      }
    ]
  )
}
</code></pre>
<h3><a class="header" href="#querying-materialized-data" id="querying-materialized-data">Querying materialized data</a></h3>
<p>After a second we should be able to see our materialized view in Postgres.</p>
<pre><code class="language-sh">psql -U postgres --password -h localhost
</code></pre>
<p>The default password for local dev Postgres is <code>1234</code>, but shhh, dont tell anyone ;-)</p>
<pre><code>postgres=# select * from cdl.materialized_view; 
              object_id               | worker_name
--------------------------------------+-------------
 dc8cc976-412b-11eb-8000-100000000000 | &quot;John&quot;
 dc8cc976-412b-11eb-8000-000000000000 | &quot;Alice&quot;
(2 rows)
</code></pre>
<h3><a class="header" href="#on-demand-materialization" id="on-demand-materialization">On-Demand materialization</a></h3>
<p>Instead of waiting seconds for on-the-fly materialization, we can also demand materialized view via gRPC call.</p>
<h4><a class="header" href="#a-grpc-api-2" id="a-grpc-api-2">A) gRPC API</a></h4>
<p>gRPC request to <a href="http://localhost:50108/">http://localhost:50108/</a> (<code>materializer_ondemand.OnDemandMaterializer.Materialize</code>):</p>
<pre><code class="language-json">{
  &quot;view_id&quot;: &quot;ddfc1f23-7b13-4d8e-b8ab-1def8eb30a4e&quot;,
  &quot;schemas&quot;: {
    &quot;22c8ac58-155e-4643-ab44-42e96dbb88c7&quot;: {
      &quot;object_ids&quot;: [
         &quot;dc8cc976-412b-11eb-8000-100000000000&quot;,
         &quot;dc8cc976-412b-11eb-8000-000000000000&quot;
      ]
    }
  }
}
</code></pre>
<p>For now user needs to use filter and enlist in the request all object ids. There is, however, <a href="https://github.com/epiphany-platform/CommonDataLayer/issues/429">an issue which should mitigate this problem</a> very soon.</p>
<p>This call returns the stream of rows, instead of collection. Thanks to that, both object builder, on demand materializer and client code don't have to allocate enormous amount of memory when handling bigger tables.</p>
<p>It also means client code can start processing data faster.</p>
<p>BloomRPC returns messages in seperate tabs:</p>
<p>Stream 1:</p>
<pre><code class="language-json">{
  &quot;fields&quot;: {
    &quot;worker_name&quot;: &quot;\&quot;John\&quot;&quot;
  },
  &quot;object_id&quot;: &quot;dc8cc976-412b-11eb-8000-100000000000&quot;
}
</code></pre>
<p>Stream 2:</p>
<pre><code class="language-json">{
  &quot;fields&quot;: {
    &quot;worker_name&quot;: &quot;\&quot;Alice\&quot;&quot;
  },
  &quot;object_id&quot;: &quot;dc8cc976-412b-11eb-8000-000000000000&quot;
}
</code></pre>
<h4><a class="header" href="#b-graphql-api-management-and-test-purposes-only-3" id="b-graphql-api-management-and-test-purposes-only-3">B) graphQL API (management and test purposes only)</a></h4>
<p>graphQL request:</p>
<pre><code class="language-graphql">query onDemandView {
  onDemandView(
    request: {
      viewId: &quot;ddfc1f23-7b13-4d8e-b8ab-1def8eb30a4e&quot;
      schemas: [
        {
          id: &quot;22c8ac58-155e-4643-ab44-42e96dbb88c7&quot;
          objectIds: [
            &quot;dc8cc976-412b-11eb-8000-100000000000&quot;,
            &quot;dc8cc976-412b-11eb-8000-000000000000&quot;
          ]
        }
      ]
    }
  ) {
    id
    rows {
      fields
      objectId
    }
  }
}
</code></pre>
<p>Unfortunately, graphQL does not support streaming, which means all rows are collected to the array before sending it to the client.
Please use it wisely and carefuly (on smaller sets of data).</p>
<h3><a class="header" href="#appendix-checking-traces-in-jaeger" id="appendix-checking-traces-in-jaeger">Appendix: Checking traces in Jaeger</a></h3>
<p>For troubleshooting or when you are curious how CDL works, we recommend using Jaeger telemetry sink, which by default is available at <a href="http://localhost:16686/search">http://localhost:16686/search</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../examples/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../features/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../examples/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../features/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
