<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0002 - Materialization - Overview - The Common Data Layer</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Common Data Layer</a></li><li class="chapter-item expanded "><a href="../how_it_works.html"><strong aria-hidden="true">2.</strong> How does it work</a></li><li class="chapter-item expanded "><a href="../getting_started.html"><strong aria-hidden="true">3.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../deployment/index.html"><strong aria-hidden="true">4.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/local/index.html"><strong aria-hidden="true">4.1.</strong> Local deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/local/docker-compose.html"><strong aria-hidden="true">4.1.1.</strong> docker-compose</a></li><li class="chapter-item expanded "><a href="../deployment/local/helm.html"><strong aria-hidden="true">4.1.2.</strong> Helm</a></li></ol></li><li class="chapter-item expanded "><a href="../deployment/production/index.html"><strong aria-hidden="true">4.2.</strong> Production-grade deployment</a></li></ol></li><li class="chapter-item expanded "><a href="../schemas_and_views.html"><strong aria-hidden="true">5.</strong> Schemas and Views</a></li><li class="chapter-item expanded "><a href="../examples/index.html"><strong aria-hidden="true">6.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/materialization.html"><strong aria-hidden="true">6.1.</strong> Materialization</a></li></ol></li><li class="chapter-item expanded "><a href="../features/index.html"><strong aria-hidden="true">7.</strong> Features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../features/ordering.html"><strong aria-hidden="true">7.1.</strong> Message ordering</a></li><li class="chapter-item expanded "><a href="../features/client_routing.html"><strong aria-hidden="true">7.2.</strong> Client routing</a></li></ol></li><li class="chapter-item expanded "><a href="../processes/index.html"><strong aria-hidden="true">8.</strong> Processes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../processes/0001_Commit_message_formalization_and_enforcement.html"><strong aria-hidden="true">8.1.</strong> Commit message formalization and enforcement</a></li><li class="chapter-item expanded "><a href="../processes/0002_Branching_strategy.html"><strong aria-hidden="true">8.2.</strong> Branhing strategy</a></li><li class="chapter-item expanded "><a href="../processes/0003_Documentation_structure_and_RFC_process.html"><strong aria-hidden="true">8.3.</strong> Documentation structure and RFC process</a></li></ol></li><li class="chapter-item expanded "><a href="../versioning.html"><strong aria-hidden="true">9.</strong> Versioning</a></li><li class="chapter-item expanded "><a href="../protocol.html"><strong aria-hidden="true">10.</strong> Protocol schema</a></li><li class="chapter-item expanded "><a href="../benchmarks.html"><strong aria-hidden="true">11.</strong> Benchmarks</a></li><li class="chapter-item expanded "><a href="../architecture/index.html"><strong aria-hidden="true">12.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/management.html"><strong aria-hidden="true">12.1.</strong> Management Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/cli.html"><strong aria-hidden="true">12.1.1.</strong> CLI</a></li><li class="chapter-item expanded "><a href="../architecture/web_admin.html"><strong aria-hidden="true">12.1.2.</strong> Admin Web Panel</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/api.html"><strong aria-hidden="true">12.2.</strong> GraphQL API</a></li><li class="chapter-item expanded "><a href="../architecture/configuration.html"><strong aria-hidden="true">12.3.</strong> Configuration Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/schema_registry.html"><strong aria-hidden="true">12.3.1.</strong> Schema Registry</a></li><li class="chapter-item expanded "><a href="../architecture/leader_elector.html"><strong aria-hidden="true">12.3.2.</strong> Leader Elector</a></li><li class="chapter-item expanded "><a href="../architecture/edge_registry.html"><strong aria-hidden="true">12.3.3.</strong> Edge Registry</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/ingestion.html"><strong aria-hidden="true">12.4.</strong> Ingestion Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/data_router.html"><strong aria-hidden="true">12.4.1.</strong> Data Router</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/storage.html"><strong aria-hidden="true">12.5.</strong> Storage Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/command_service.html"><strong aria-hidden="true">12.5.1.</strong> Command Service</a></li><li class="chapter-item expanded "><a href="../architecture/db_shrinker_storage.html"><strong aria-hidden="true">12.5.2.</strong> Db Shrinker Storage</a></li><li class="chapter-item expanded "><a href="../architecture/query_service.html"><strong aria-hidden="true">12.5.3.</strong> Query Service</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.6.</strong> Materialization Layer</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/object_builder.html"><strong aria-hidden="true">12.6.1.</strong> Object Builder</a></li><li class="chapter-item expanded "><a href="../architecture/partial_update_engine.html"><strong aria-hidden="true">12.6.2.</strong> Partial Update Engine</a></li><li class="chapter-item expanded "><a href="../architecture/materializer_general.html"><strong aria-hidden="true">12.6.3.</strong> General Materializer</a></li><li class="chapter-item expanded "><a href="../architecture/materializer_ondemand.html"><strong aria-hidden="true">12.6.4.</strong> On Demand Materializer</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/retrieval.html"><strong aria-hidden="true">12.7.</strong> Retrieval Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/query_router.html"><strong aria-hidden="true">12.7.1.</strong> Query Router</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/utils.html"><strong aria-hidden="true">12.8.</strong> Utils</a></li></ol></li><li class="chapter-item expanded "><a href="../configuration/index.html"><strong aria-hidden="true">13.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../configuration/generator.html"><strong aria-hidden="true">13.1.</strong> (tool) generator</a></li><li class="chapter-item expanded "><a href="../configuration/api.html"><strong aria-hidden="true">13.2.</strong> api</a></li><li class="chapter-item expanded "><a href="../configuration/command-service.html"><strong aria-hidden="true">13.3.</strong> command-service</a></li><li class="chapter-item expanded "><a href="../configuration/data-router.html"><strong aria-hidden="true">13.4.</strong> data-router</a></li><li class="chapter-item expanded "><a href="../configuration/edge-registry.html"><strong aria-hidden="true">13.5.</strong> edge-registry</a></li><li class="chapter-item expanded "><a href="../configuration/materializer-general.html"><strong aria-hidden="true">13.6.</strong> materializer-general</a></li><li class="chapter-item expanded "><a href="../configuration/materializer-ondemand.html"><strong aria-hidden="true">13.7.</strong> materializer-ondemand</a></li><li class="chapter-item expanded "><a href="../configuration/object-builder.html"><strong aria-hidden="true">13.8.</strong> object-builder</a></li><li class="chapter-item expanded "><a href="../configuration/partial-update-engine.html"><strong aria-hidden="true">13.9.</strong> partial-update-engine</a></li><li class="chapter-item expanded "><a href="../configuration/query-router.html"><strong aria-hidden="true">13.10.</strong> query-router</a></li><li class="chapter-item expanded "><a href="../configuration/query-service.html"><strong aria-hidden="true">13.11.</strong> query-service</a></li><li class="chapter-item expanded "><a href="../configuration/query-service-ts.html"><strong aria-hidden="true">13.12.</strong> query-service-ts</a></li><li class="chapter-item expanded "><a href="../configuration/schema-registry.html"><strong aria-hidden="true">13.13.</strong> schema-registry</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> RFCs</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfc/0022_Materialization_Types_01.html"><strong aria-hidden="true">14.1.</strong> 0022 - Materialization Types</a></li><li class="chapter-item expanded "><a href="../rfc/0021_Custom_Data_Passthrough_01.html"><strong aria-hidden="true">14.2.</strong> 0021 - Custom Data Passthrough</a></li><li class="chapter-item expanded "><a href="../rfc/0020_Configuration_Service_01.html"><strong aria-hidden="true">14.3.</strong> 0020 - Configuration service</a></li><li class="chapter-item expanded "><a href="../rfc/0019_Simplify_Schema_Definitions_01.html"><strong aria-hidden="true">14.4.</strong> 0019 - Simplify Schema Definitions</a></li><li class="chapter-item expanded "><a href="../rfc/0018_Transport_headers_passthrough_01.html"><strong aria-hidden="true">14.5.</strong> 0018 - Transport headers passthrough</a></li><li class="chapter-item expanded "><a href="../rfc/0017_Edge_registry_resolving_relation_trees_01.html"><strong aria-hidden="true">14.6.</strong> 0017 - Edge Registry: Resolving relation trees</a></li><li class="chapter-item expanded "><a href="../rfc/0015_CI_CD_RnD_01.html"><strong aria-hidden="true">14.7.</strong> 0015 - CI/CD setup R&amp;D</a></li><li class="chapter-item expanded "><a href="../rfc/0014_Query_raw_routes_01.html"><strong aria-hidden="true">14.8.</strong> 0014 - Query raw routes</a></li><li class="chapter-item expanded "><a href="../rfc/0013_Documentation_restructure_and_RFC_process_01.html"><strong aria-hidden="true">14.9.</strong> 0013 - Documentation restructure and RFC process</a></li><li class="chapter-item expanded "><a href="../rfc/0012_CDL_documentation_generation_01.html"><strong aria-hidden="true">14.10.</strong> 0012 - CDL Documentation Generation</a></li><li class="chapter-item expanded "><a href="../rfc/0011_Branching_strategy_01.html"><strong aria-hidden="true">14.11.</strong> 0011 - Branching strategy</a></li><li class="chapter-item expanded "><a href="../rfc/0010_Schema_Registry_less_CDL_deployment_01.html"><strong aria-hidden="true">14.12.</strong> 0010 - Schema-Registry-less CDL deployment</a></li><li class="chapter-item expanded "><a href="../rfc/0009_CDL_Ingestion_API_versioning_02.html"><strong aria-hidden="true">14.13.</strong> 0009 - CdlIM Versioning 2.0</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfc/archive/0005_CDL_Ingestion_API_versioning_01.html"><strong aria-hidden="true">14.13.1.</strong> 0005 - CdlIM Versioning</a></li></ol></li><li class="chapter-item expanded "><a href="../rfc/0008_CDL_publishing_deployment_configurations_01.html"><strong aria-hidden="true">14.14.</strong> 0008 - CDL publishing deployment configurations</a></li><li class="chapter-item expanded "><a href="../rfc/0007_Materialized_views_01.html"><strong aria-hidden="true">14.15.</strong> 0007 - Materialized Views</a></li><li class="chapter-item expanded "><a href="../rfc/0006_Edge_registry_01.html"><strong aria-hidden="true">14.16.</strong> 0006 - Edge Registry</a></li><li class="chapter-item expanded "><a href="../rfc/0004_Commit_message_formalization_and_enforcement_01.html"><strong aria-hidden="true">14.17.</strong> 0004 - Commit message formalization</a></li><li class="chapter-item expanded "><a href="../rfc/0003_Usage_of_Message_Pack_format_as_a_CDL_input_01.html"><strong aria-hidden="true">14.18.</strong> 0003 - MessagePack support</a></li><li class="chapter-item expanded "><a href="../rfc/0002_Materialization_01.html" class="active"><strong aria-hidden="true">14.19.</strong> 0002 - Materialization - Overview</a></li><li class="chapter-item expanded "><a href="../rfc/0001_Alternative_communication_method_01.html"><strong aria-hidden="true">14.20.</strong> 0001 - Alternative communication method</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Common Data Layer</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/epiphany-platform/CommonDataLayer" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#front-matter" id="front-matter">Front Matter</a></h1>
<pre><code>    Title           : Materialization
    Author(s)       : Sam Mohr
    Team            : CommonDataLayer
    Reviewer        : CommonDataLayer
    Created         : 2021-02-07
    Last updated    : 2021-02-11
    Category        : Feature
    CDL Feature ID  : CDLF-00011-00
</code></pre>
<h1><a class="header" href="#introduction" id="introduction">Introduction</a></h1>
<p>Demand has been expressed for Materialization by multiple clients.</p>
<h2><a class="header" href="#summary" id="summary">Summary</a></h2>
<p>Materialization is the projection of value(s) into a different format.</p>
<p>Materialization in the Common Data Layer will need to provide some means
to project data (either a single value or a combination of values) in a
user-defined manner.</p>
<h2><a class="header" href="#context" id="context">Context</a></h2>
<h3><a class="header" href="#origin" id="origin">Origin</a></h3>
<p>Materialization was suggested as a potential feature in the CDL a while ago
as a means for teams using the CDL for storage to make complicated queries
quicker to read by simply precalculating the results and then caching them.
It was recently brought up again as potential client teams saw the usefulness
in materialization and requested it be implemented for their use.</p>
<h3><a class="header" href="#previous-efforts" id="previous-efforts">Previous Efforts</a></h3>
<p>The CDL Lite, a small, monolithic version of the CDL created during the
prototyping phase of the CDL for testing performance, has a version of
materialization implemented. The solution involves adding two extra types
to each Schema: Views and Relations. </p>
<p>Schemas can have zero to many views, and views are each defined as a format
to map a value belonging to a schema into using <a href="https://jmespath.org">JMESPath</a>. Any schema
can point to any other schema (like a directed edge in a graph) with a relation,
which defines a parent-child relationship between schemas. For safety, there is
a recursion limit when loading child data to allow users to configure cyclical
relationships but preventing memory overloads.</p>
<p>The combination of views and relations allows for deterministic projection of any
value under a schema into a user-defined format, even allowing for the inclusion
of pluralities of data belonging to other schemas. However, this solution was only
implemented in the CDL Lite because the CDL Lite runs on a single binary and a
single database, and has no need to use the network to retrieve data from other
repositories. If a schema's relation points to data in other repositories, the full
version of the CDL would need to make a network request for data in any different
repository at least once and probably more, which incurs a very high networking cost.
This would need to be mitigated if we consider this solution for the full CDL.</p>
<h3><a class="header" href="#how-it-affects-other-components" id="how-it-affects-other-components">How It Affects Other Components</a></h3>
<p>The CDL was designed to be agnostic of the format of data stored in it, as well
as where it is stored. To that end, all possible repositories simply implement a
common interface for accepting arbitrary data for storage, and those repositories
don't communicate with each other, only ingesting from the common Data Router and
reporting insertions of data to a common Kafka topic.</p>
<p>However, data can be directly inserted into any repository through its respective
Command Service, and if a user uses their own Command Service that they wrote
themselves, then there is no constraint currently requiring them to properly report
insertion events over Kafka.</p>
<p>If some materialization is recalculated based on when data updates, we don't have
a consistent means (currently) of determining when data was successfully inserted
into an arbitrary repository, and will need to find one, or only support periodic
recalculations if any.</p>
<h2><a class="header" href="#technical-requirements" id="technical-requirements">Technical Requirements</a></h2>
<p>We will need to provide projection either for single values or multiple values, even
distributed across multiple repositories. The projection will need to be available
both on-demand and recalculated automatically when values are updated in storage.
For at least projections recalculated on change, they will need to be cached in
ElasticSearch, and potentially other user-defined caches in the future.</p>
<h2><a class="header" href="#out-of-scope" id="out-of-scope">Out of Scope</a></h2>
<p>At least for now, partial updates of cached data are out of scope for this feature.
They are extremely complex in their interaction with the proposed approaches in this RFC,
and would take far too long to implement in the same time span as the rest of the work
entailed by this feature.</p>
<h2><a class="header" href="#future-goals" id="future-goals">Future Goals</a></h2>
<p>Though generically implementing storage in caches like ElasticSearch in this story
will simplify later efforts to support other caches (e.g. MySQL, Redis, etc.), it
is not a requirement. However, at some point, it would be useful to provide these 
other caches for users and allow them to configure which caches to either store all
data in, or the data for specific projections.</p>
<h1><a class="header" href="#solutions" id="solutions">Solutions</a></h1>
<p>As materialization will likely comprise multiple components all forming a solution,
this RFC will discuss the options for each component, which are:</p>
<ul>
<li>Method of Materialization</li>
<li>On-Demand Materialization (calculation of projections per request)</li>
<li>Cached Materialization (calculation of projections without prompting)</li>
<li>Caching of Materialization (storage of projections in a cache, namely ElasticSearch for now)</li>
<li>Configuration of Materialization</li>
</ul>
<h2><a class="header" href="#method-of-materialization" id="method-of-materialization">Method of Materialization</a></h2>
<h3><a class="header" href="#method-1-adaptation-of-cdl-lite-approach" id="method-1-adaptation-of-cdl-lite-approach">Method 1: Adaptation of CDL Lite Approach</a></h3>
<p>The CDL Lite approach (<a href="#previous-efforts">seen above</a>) describes adding Views and Relations
to schemas such that any value under a schema can deterministically be projected (including
child values belonging to child schemas based on the parent schema's relations). For example,
given a schema <code>Work Order</code> that has a child schema <code>Asset</code>, the definition of a view <code>Cost</code>
written as the <a href="https://jmespath.org">JMESPath</a> <code>{ cost: cost + sum(assets[].cost) }</code> for <code>Work Order</code>s,
the <code>Cost</code> view could be deterministically calculated for each <code>Work Order</code>.</p>
<p>Views would have the fields <code>name</code> and <code>jmespath</code>, and schemas would have zero to many views.
Relations would have the fields <code>optional</code>, <code>terminal</code>, and <code>path</code>. <code>optional</code> determines whether
an error should be thrown if no children are present. <code>terminal</code> determines what type of ID's are
found at the end of the <code>path</code> for this relation (a single ID, a list of ID's, or a map of ID's).
The <code>path</code> is the path to the ID's of the children from the root of a child value, e.g. a path
of <code>[ &quot;birthday&quot;, &quot;id&quot; ]</code> in an object</p>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;John Doe&quot;,
  &quot;birthday&quot;: {
    &quot;month&quot;: &quot;February&quot;,
    &quot;day&quot;: 12,
    &quot;year&quot;: 1975,
    &quot;id&quot;: &quot;valid-uuid&quot;
  }
}
</code></pre>
<p>will render &quot;valid-uuid&quot;.</p>
<p>To calculate the projection for a view, first get all of the children of the given value based
on the child relations of its schema (and their respective children recursively) replace the ID's
at the end of each <code>path</code> with the value under the respective ID, and then calculate the view of
the data with all child data incorporated.</p>
<h4><a class="header" href="#pros" id="pros">Pros</a></h4>
<p>This solution offers highly configurable output, even beyond the combination of arbitrary
values, this allows for complex operations on the data using anything that JMESPath provides.
Also, rather than having to specify a view for every specific value, any value under a schema
can be automatically materialized.</p>
<h4><a class="header" href="#cons" id="cons">Cons</a></h4>
<p>Unfortunately, as mentioned with this solution's place in the CDL Lite, the number of network
requests in this solution is O(m + n), where m is the number of schemas and n is the number of
data values requested. So long as users can use these features freely, there is potential for
serious performance loss. The best option is to keep these complicated features, but to inform
users that using complex views and relations will cause slow performance. In addition, partial
updates will be extremely difficult to implement later.</p>
<h3><a class="header" href="#method-2-simple-joins-only" id="method-2-simple-joins-only">Method 2: Simple Joins Only</a></h3>
<p>With the versatility of JMESPath and it's options for manipulating data, users are able to perform
an extremely wide number of complex calculations and aggregations of the data stored in the CDL.
This makes it more difficult for us to determine what users have done, and by extension, to know
accurately what data under a schema requires updating, forcing an update of every value under a
schema when any dependency changes.</p>
<p>Most of the behaviors we are providing to users for the combination and aggregation of data are
available in the cache services, but would be slower and defeat the point of precalculating and
caching their desired format. However, from when materialization was first proposed, the wants
of users were very simple: just the ability to &quot;join&quot; data.</p>
<p>To simplify things, we can constrain the possible operations in JMESPath by either removing the
included functions like addition and division, or by forking JMESPath to define our own
highly-simplified version of the format (both to constrain users and our development time).</p>
<h4><a class="header" href="#pros-1" id="pros-1">Pros</a></h4>
<p>Either way, simply providing a way to reshape data while still providing all of the other features
in the same manner will satisfy most of our users without giving them a potential footgun that
will need to be strongly documented.</p>
<h4><a class="header" href="#cons-1" id="cons-1">Cons</a></h4>
<p>This approach would take more research, especially if we decide to fork JMESPath instead of
constraining the existing implementation. Also, for those users that would prefer to do all of the
work in one spot, they will be left needing to do work in two places: in the CDL and then in their
chosen cache (e.g. ElasticSearch).</p>
<h2><a class="header" href="#the-materialization-services" id="the-materialization-services">The Materialization Service(s)</a></h2>
<p>The materialization service(s) for eager and automatic projection will each be responsible for
collecting data from various repositories, manipulating it, and either sending it somewhere. In
this shared behavior leaves two solutions: move the common behavior to a library and render as 
two applications, or write a single common application that performs both tasks internally and
has one input port for materialization requests as well as a &quot;cron&quot; job for materialization to
be sent to a cache such as ElasticSearch.</p>
<h3><a class="header" href="#method-1-a-library-used-by-2-services" id="method-1-a-library-used-by-2-services">Method 1: A Library Used by 2 Services</a></h3>
<p>A library is the de facto way to move common behavior from multiple applications to one place.
Thus, in spite of the cost of adding yet another crate to our compilation process, the code cleanup
and resultant simplification of the 2 services would be great for long-term maintainability. Also,
in deployment of multiple instances of each application, resource usage would be more correctly
distributed where needed when the services run in different processes, especially if there is a
significant difference in the number of requests to one service or another.</p>
<h3><a class="header" href="#method-2-a-single-common-service" id="method-2-a-single-common-service">Method 2: A Single, Common Service</a></h3>
<p>On the other hand, the library holding the common materialization logic would not be useful
elsewhere in our application, and may not be worth the effort to separate from our services. Though
on the surface, there is benefit in code structure and proper resource distribution with the 2
service-approach, code structure can be achieved with good use of modules, and <code>tokio</code> will properly
handle the distribution of resource if the application properly leverages async behavior, which the
CDL already does everywhere else.</p>
<h2><a class="header" href="#caching-of-materialized-data" id="caching-of-materialized-data">Caching of Materialized Data</a></h2>
<p>The current expected behavior is to store all data in ElasticSearch, but in keeping with the CDL's
philosophy of dynamic modules, we will ideally, at some point in the future, support multiple caches,
or even better, user-defined caches. The decision to be made is whether to provide infrastructure
now to plan for the future, or to implement a functional solution for now and extend it later.</p>
<p>To implement it now, the most straight-forward approach is to follow the way of the Command Service
and add a user service for each cache called a Cache Service that takes data from the materialization
service(s) over gRPC and stores it in a user-defined cache. This would mean creating a gRPC definition
for the cache service, and interfacing only with ElasticSearch for now, likely through the <a href="https://docs.rs/elasticsearch/7.10.1-alpha.1/elasticsearch/">official
client library</a> for Rust, which would basically require copying of the source for
a Command Service.</p>
<p>To implement only communication with ElasticSearch would entail extending the materialization service(s)
to use the <code>elasticsearch</code> in place of a user-defined Cache Service, and to have slightly more error
handling in the materialization service(s) instead of the Cache Service. It would potentially be able
to determine earlier if failure occurred in storing projected data in the cache, but users would be able
to observe when materialization issues occur by looking at when the last update was made to the cached
data and comparing it to the normal rate of update.</p>
<p>The simpler approach is to leave more work for later, but it is more beneficial to the structure of
this project to separate it for a good separation of concerns and a more common structure across our
sub-applications.</p>
<h2><a class="header" href="#configuration-of-materialization" id="configuration-of-materialization">Configuration of Materialization</a></h2>
<h3><a class="header" href="#what-to-store" id="what-to-store">What to Store</a></h3>
<p>The main data to be stored is the definitions of the materialization to be done and how often it
should be recalculated. Views and Relations have already been defined above, so the following fields
are for configuration of materialization frequency:</p>
<table><thead><tr><th align="right">Field</th><th align="center">Type</th><th align="left">Description</th></tr></thead><tbody>
<tr><td align="right">eager</td><td align="center">bool</td><td align="left">whether to recalculate on every update</td></tr>
<tr><td align="right">minWaitTime</td><td align="center">int</td><td align="left">minimum number of seconds to wait between updates</td></tr>
<tr><td align="right">updateEvery</td><td align="center">int</td><td align="left">number of seconds to update after when updates arrive</td></tr>
</tbody></table>
<h3><a class="header" href="#where" id="where">Where</a></h3>
<p>Though it would be possible to store the configuration information where it is needed (in the
materialization service(s)), we already have the schema registry and a configuration service (in
development), so there are more appropriate locations for configuration data to be stored. </p>
<p>If the materialization is per-schema, then the obvious approach is to extend what a schema holds and
store materialization definitions there. However, for the metadata about when to update projections,
it makes more sense to move it to the configuration service like the metadata for schemas. For schema
data, we are making the distinction between business data and application behavior, which is JSON Schema
definitions and Kafka topics/AMQP exchanges, respectively.</p>
<h2><a class="header" href="#test-plan" id="test-plan">Test Plan</a></h2>
<p>The simple use cases are:</p>
<ul>
<li>Eager materialization</li>
<li>Caching of projected data</li>
<li>Addition of materializer definitions</li>
<li>Configuration of automatic projection timing</li>
</ul>
<p>These cases can all be tested primarily with manual testing, with some unit tests advised.</p>
<p>The primary complex use cases are:</p>
<ul>
<li>Deeply-nested data</li>
<li>Inter-related schema projection</li>
<li>Proper cache updates when complex data updates</li>
</ul>
<p>Though at least manual testing is required for these, at least some Python tests should be added
to ensure that this feature isn't accidentally broken by future feature additions.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../rfc/0003_Usage_of_Message_Pack_format_as_a_CDL_input_01.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../rfc/0001_Alternative_communication_method_01.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../rfc/0003_Usage_of_Message_Pack_format_as_a_CDL_input_01.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../rfc/0001_Alternative_communication_method_01.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
