<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0003 - MessagePack support - The Common Data Layer</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Common Data Layer</a></li><li class="chapter-item expanded "><a href="../how_it_works.html"><strong aria-hidden="true">2.</strong> How does it work</a></li><li class="chapter-item expanded "><a href="../getting_started.html"><strong aria-hidden="true">3.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../deployment/index.html"><strong aria-hidden="true">4.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/local/index.html"><strong aria-hidden="true">4.1.</strong> Local deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/local/docker-compose.html"><strong aria-hidden="true">4.1.1.</strong> docker-compose</a></li><li class="chapter-item expanded "><a href="../deployment/local/helm.html"><strong aria-hidden="true">4.1.2.</strong> Helm</a></li></ol></li><li class="chapter-item expanded "><a href="../deployment/production/index.html"><strong aria-hidden="true">4.2.</strong> Production-grade deployment</a></li></ol></li><li class="chapter-item expanded "><a href="../schemas_and_views.html"><strong aria-hidden="true">5.</strong> Schemas and Views</a></li><li class="chapter-item expanded "><a href="../examples/index.html"><strong aria-hidden="true">6.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/materialization.html"><strong aria-hidden="true">6.1.</strong> Materialization</a></li></ol></li><li class="chapter-item expanded "><a href="../features/index.html"><strong aria-hidden="true">7.</strong> Features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../features/ordering.html"><strong aria-hidden="true">7.1.</strong> Message ordering</a></li><li class="chapter-item expanded "><a href="../features/client_routing.html"><strong aria-hidden="true">7.2.</strong> Client routing</a></li></ol></li><li class="chapter-item expanded "><a href="../processes/index.html"><strong aria-hidden="true">8.</strong> Processes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../processes/0001_Commit_message_formalization_and_enforcement.html"><strong aria-hidden="true">8.1.</strong> Commit message formalization and enforcement</a></li><li class="chapter-item expanded "><a href="../processes/0002_Branching_strategy.html"><strong aria-hidden="true">8.2.</strong> Branhing strategy</a></li><li class="chapter-item expanded "><a href="../processes/0003_Documentation_structure_and_RFC_process.html"><strong aria-hidden="true">8.3.</strong> Documentation structure and RFC process</a></li></ol></li><li class="chapter-item expanded "><a href="../versioning.html"><strong aria-hidden="true">9.</strong> Versioning</a></li><li class="chapter-item expanded "><a href="../protocol.html"><strong aria-hidden="true">10.</strong> Protocol schema</a></li><li class="chapter-item expanded "><a href="../benchmarks.html"><strong aria-hidden="true">11.</strong> Benchmarks</a></li><li class="chapter-item expanded "><a href="../architecture/index.html"><strong aria-hidden="true">12.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/management.html"><strong aria-hidden="true">12.1.</strong> Management Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/cli.html"><strong aria-hidden="true">12.1.1.</strong> CLI</a></li><li class="chapter-item expanded "><a href="../architecture/web_admin.html"><strong aria-hidden="true">12.1.2.</strong> Admin Web Panel</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/api.html"><strong aria-hidden="true">12.2.</strong> GraphQL API</a></li><li class="chapter-item expanded "><a href="../architecture/configuration.html"><strong aria-hidden="true">12.3.</strong> Configuration Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/schema_registry.html"><strong aria-hidden="true">12.3.1.</strong> Schema Registry</a></li><li class="chapter-item expanded "><a href="../architecture/leader_elector.html"><strong aria-hidden="true">12.3.2.</strong> Leader Elector</a></li><li class="chapter-item expanded "><a href="../architecture/edge_registry.html"><strong aria-hidden="true">12.3.3.</strong> Edge Registry</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/ingestion.html"><strong aria-hidden="true">12.4.</strong> Ingestion Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/data_router.html"><strong aria-hidden="true">12.4.1.</strong> Data Router</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/storage.html"><strong aria-hidden="true">12.5.</strong> Storage Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/command_service.html"><strong aria-hidden="true">12.5.1.</strong> Command Service</a></li><li class="chapter-item expanded "><a href="../architecture/db_shrinker_storage.html"><strong aria-hidden="true">12.5.2.</strong> Db Shrinker Storage</a></li><li class="chapter-item expanded "><a href="../architecture/query_service.html"><strong aria-hidden="true">12.5.3.</strong> Query Service</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.6.</strong> Materialization Layer</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/object_builder.html"><strong aria-hidden="true">12.6.1.</strong> Object Builder</a></li><li class="chapter-item expanded "><a href="../architecture/partial_update_engine.html"><strong aria-hidden="true">12.6.2.</strong> Partial Update Engine</a></li><li class="chapter-item expanded "><a href="../architecture/materializer_general.html"><strong aria-hidden="true">12.6.3.</strong> General Materializer</a></li><li class="chapter-item expanded "><a href="../architecture/materializer_ondemand.html"><strong aria-hidden="true">12.6.4.</strong> On Demand Materializer</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/retrieval.html"><strong aria-hidden="true">12.7.</strong> Retrieval Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/query_router.html"><strong aria-hidden="true">12.7.1.</strong> Query Router</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/utils.html"><strong aria-hidden="true">12.8.</strong> Utils</a></li></ol></li><li class="chapter-item expanded "><a href="../configuration/index.html"><strong aria-hidden="true">13.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../configuration/generator.html"><strong aria-hidden="true">13.1.</strong> (tool) generator</a></li><li class="chapter-item expanded "><a href="../configuration/api.html"><strong aria-hidden="true">13.2.</strong> api</a></li><li class="chapter-item expanded "><a href="../configuration/command-service.html"><strong aria-hidden="true">13.3.</strong> command-service</a></li><li class="chapter-item expanded "><a href="../configuration/data-router.html"><strong aria-hidden="true">13.4.</strong> data-router</a></li><li class="chapter-item expanded "><a href="../configuration/edge-registry.html"><strong aria-hidden="true">13.5.</strong> edge-registry</a></li><li class="chapter-item expanded "><a href="../configuration/materializer-general.html"><strong aria-hidden="true">13.6.</strong> materializer-general</a></li><li class="chapter-item expanded "><a href="../configuration/materializer-ondemand.html"><strong aria-hidden="true">13.7.</strong> materializer-ondemand</a></li><li class="chapter-item expanded "><a href="../configuration/object-builder.html"><strong aria-hidden="true">13.8.</strong> object-builder</a></li><li class="chapter-item expanded "><a href="../configuration/partial-update-engine.html"><strong aria-hidden="true">13.9.</strong> partial-update-engine</a></li><li class="chapter-item expanded "><a href="../configuration/query-router.html"><strong aria-hidden="true">13.10.</strong> query-router</a></li><li class="chapter-item expanded "><a href="../configuration/query-service.html"><strong aria-hidden="true">13.11.</strong> query-service</a></li><li class="chapter-item expanded "><a href="../configuration/query-service-ts.html"><strong aria-hidden="true">13.12.</strong> query-service-ts</a></li><li class="chapter-item expanded "><a href="../configuration/schema-registry.html"><strong aria-hidden="true">13.13.</strong> schema-registry</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> RFCs</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfc/0022_Materialization_Types_01.html"><strong aria-hidden="true">14.1.</strong> 0022 - Materialization Types</a></li><li class="chapter-item expanded "><a href="../rfc/0021_Custom_Data_Passthrough_01.html"><strong aria-hidden="true">14.2.</strong> 0021 - Custom Data Passthrough</a></li><li class="chapter-item expanded "><a href="../rfc/0020_Configuration_Service_01.html"><strong aria-hidden="true">14.3.</strong> 0020 - Configuration service</a></li><li class="chapter-item expanded "><a href="../rfc/0019_Simplify_Schema_Definitions_01.html"><strong aria-hidden="true">14.4.</strong> 0019 - Simplify Schema Definitions</a></li><li class="chapter-item expanded "><a href="../rfc/0018_Transport_headers_passthrough_01.html"><strong aria-hidden="true">14.5.</strong> 0018 - Transport headers passthrough</a></li><li class="chapter-item expanded "><a href="../rfc/0017_Edge_registry_resolving_relation_trees_01.html"><strong aria-hidden="true">14.6.</strong> 0017 - Edge Registry: Resolving relation trees</a></li><li class="chapter-item expanded "><a href="../rfc/0015_CI_CD_RnD_01.html"><strong aria-hidden="true">14.7.</strong> 0015 - CI/CD setup R&amp;D</a></li><li class="chapter-item expanded "><a href="../rfc/0014_Query_raw_routes_01.html"><strong aria-hidden="true">14.8.</strong> 0014 - Query raw routes</a></li><li class="chapter-item expanded "><a href="../rfc/0013_Documentation_restructure_and_RFC_process_01.html"><strong aria-hidden="true">14.9.</strong> 0013 - Documentation restructure and RFC process</a></li><li class="chapter-item expanded "><a href="../rfc/0012_CDL_documentation_generation_01.html"><strong aria-hidden="true">14.10.</strong> 0012 - CDL Documentation Generation</a></li><li class="chapter-item expanded "><a href="../rfc/0011_Branching_strategy_01.html"><strong aria-hidden="true">14.11.</strong> 0011 - Branching strategy</a></li><li class="chapter-item expanded "><a href="../rfc/0010_Schema_Registry_less_CDL_deployment_01.html"><strong aria-hidden="true">14.12.</strong> 0010 - Schema-Registry-less CDL deployment</a></li><li class="chapter-item expanded "><a href="../rfc/0009_CDL_Ingestion_API_versioning_02.html"><strong aria-hidden="true">14.13.</strong> 0009 - CdlIM Versioning 2.0</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfc/archive/0005_CDL_Ingestion_API_versioning_01.html"><strong aria-hidden="true">14.13.1.</strong> 0005 - CdlIM Versioning</a></li></ol></li><li class="chapter-item expanded "><a href="../rfc/0008_CDL_publishing_deployment_configurations_01.html"><strong aria-hidden="true">14.14.</strong> 0008 - CDL publishing deployment configurations</a></li><li class="chapter-item expanded "><a href="../rfc/0007_Materialized_views_01.html"><strong aria-hidden="true">14.15.</strong> 0007 - Materialized Views</a></li><li class="chapter-item expanded "><a href="../rfc/0006_Edge_registry_01.html"><strong aria-hidden="true">14.16.</strong> 0006 - Edge Registry</a></li><li class="chapter-item expanded "><a href="../rfc/0004_Commit_message_formalization_and_enforcement_01.html"><strong aria-hidden="true">14.17.</strong> 0004 - Commit message formalization</a></li><li class="chapter-item expanded "><a href="../rfc/0003_Usage_of_Message_Pack_format_as_a_CDL_input_01.html" class="active"><strong aria-hidden="true">14.18.</strong> 0003 - MessagePack support</a></li><li class="chapter-item expanded "><a href="../rfc/0002_Materialization_01.html"><strong aria-hidden="true">14.19.</strong> 0002 - Materialization - Overview</a></li><li class="chapter-item expanded "><a href="../rfc/0001_Alternative_communication_method_01.html"><strong aria-hidden="true">14.20.</strong> 0001 - Alternative communication method</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Common Data Layer</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/epiphany-platform/CommonDataLayer" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#front-matter" id="front-matter">Front Matter</a></h1>
<pre><code>    Title           : Usage of MessagePack format as a CDL input
    Author(s)       : Mateusz 'esavier' Matejuk
    Team            : CommonDataLayer
    Reviewer        : CommonDataLayer
    Created         : 2021-02-17
    Last updated    : 2021-02-17
    Category        : Feature
    CDL Feature ID  : CDLF-0000E-00
</code></pre>
<h4><a class="header" href="#abstract" id="abstract">Abstract</a></h4>
<pre><code>     The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL
     NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,  &quot;MAY&quot;, and
     &quot;OPTIONAL&quot; in this document are to be interpreted as described in
     RFC 2119.
</code></pre>
<p><a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119 source</a></p>
<h2><a class="header" href="#glossary" id="glossary">Glossary</a></h2>
<h5><a class="header" href="#terminology" id="terminology">Terminology</a></h5>
<ul>
<li>CDL - <a href="https://github.com/epiphany-platform/CommonDataLayer">Common Data Layer Project</a></li>
<li>DR - Data Router, an CDL component responsible for ingesting and routing initial messages.</li>
<li>SR - Schema Registry, an CDL component responsible for keeping information about the type of the object conveyed inside the message.</li>
<li>User - user of the CDL. In this case, the user knows how the CDL works, and is assumed to have access to the API and code unless stated otherwise.</li>
<li>Message - (abstract) message sent to CDL for processing</li>
<li>Breaking Change - change in behavior, or API of the CDL that may result with system breakage on release update.</li>
<li>MD - man-day - amount of work completed by one developer in one work day.</li>
</ul>
<h5><a class="header" href="#formats" id="formats">Formats</a></h5>
<p>v1 Input Format - messages of format v1 are not related to Message Batching, i.e. batch can consist of a list of messages, of version v1, but array itself is not a message format. Input Message v1 is formatted as follows:</p>
<pre><code>	{
	    object_id: UUID,
	    schema_id: UUID,
	    data: { any valid json },
	}
</code></pre>
<p>v1 Batch - it is a batch format introduced to alleviate some problems with transports. It conforms only to the v1 input format, and its treatment is described in RFC for batching</p>
<pre><code>[
	{  v1 message }
	{  v1 message }
	{  v1 message }
	...
	=&gt; n
]
</code></pre>
<h2><a class="header" href="#introduction" id="introduction">Introduction</a></h2>
<h4><a class="header" href="#background" id="background">Background</a></h4>
<p>In present design, DR can only ingest JSON input format, which is both inefficient, and proves to be troublesome with some features. One example of which is being binary format ingestion. It was proposed to introduce MessagePack as an alternative. MessagePack is as flexible as JSON, meaning there is no need to recompile with each alteration in the protocol, and there is no need to utilize the message schema before initiating the communication. In addition, MessagePack allows the program to maintain binary data as is, without extra escaping or encoding. The Scope of this document include only information about the CDL input transport, which is, by extension, communication between user and DR.</p>
<h4><a class="header" href="#assumptions" id="assumptions">Assumptions</a></h4>
<p>We have to assume that some users may want to retain the ability to communicate over plain JSON, and/or choose a specific format for a specific job, meaning that two formats may have to be employed at all times.</p>
<h4><a class="header" href="#preliminary-testing" id="preliminary-testing">Preliminary Testing</a></h4>
<h5><a class="header" href="#performance" id="performance">Performance</a></h5>
<p>Simple preliminary testing using rust, C, and zig (while zig implementation being quite humble) displays some improvements to using message pack format over pure JSON string.</p>
<ul>
<li>testing was performed over 1 000 000 loops, and averaged per one encoding.</li>
<li>results shown are generated by code in C, but those were similar in scale for the two other languages</li>
</ul>
<table><thead><tr><th>#</th><th>JSON</th><th>message pack</th></tr></thead><tbody>
<tr><td>avg encoding of one message</td><td>3.11 × 10-4</td><td>7.850 × 10-5</td></tr>
<tr><td>avg decoding of one message</td><td>7.91 × 10-4</td><td>1.81 × 10-4</td></tr>
</tbody></table>
<p>Similar results can be depicted in readily available publications:
<a href="https://thephp.website/en/issue/messagepack-vs-json-benchmark/">MessagePack vs Json benchmark</a></p>
<h5><a class="header" href="#length-of-the-payload" id="length-of-the-payload">Length of the Payload</a></h5>
<p>Example serialization shows that the same message that was serialized in MessagePack was smaller than in JSON.
| # | JSON    | message pack | difference | compression ratio
|---|---------|--------------|------------|------------------|
| # | 121 615 | 101 411      | 20 204      | 0.8338</p>
<h5><a class="header" href="#limitations" id="limitations">Limitations</a></h5>
<ul>
<li>integer values  are limited to 64 bytes</li>
<li>maximum length of binary object is (2^32) -1 bytes (4294967295 bytes or around 3.9 GiB)</li>
<li>maximum length of string object is (2^32) -1</li>
<li>String may be malformed, or be a non-valid UTF-8 sequence</li>
<li>maximum array length is (2^32) -1</li>
<li>maximum key-value map length is (2^32) -1
<a href="https://github.com/msgpack/msgpack/blob/3f0a9aae716596a86878c0d68dc0bd4256673202/spec.md">Source: MessagePack Specification</a></li>
<li>During research, it was apparent that only a few rust libraries support full MessagePack features, for example extensions.</li>
</ul>
<h2><a class="header" href="#solutions" id="solutions">Solutions</a></h2>
<h5><a class="header" href="#current-or-existing-solution" id="current-or-existing-solution">Current or Existing Solution</a></h5>
<p>DR can only ingest properly formatted JSON messages, consisting of either a single v1 object or an array of separate v1 objects, each potentially unrelated to each other. This means that all special characters and payloads have to be escaped or encoded in some way. Until now, it was proposed to use base64 encoding, however, for each 3 bytes encoded, base64 encoded equivalent requires 4 bytes to be transmitted, meaning 33% increase in payload  (not necessary stored), potentially also inside the CDL network.</p>
<h4><a class="header" href="#proposed-solutions---preamble" id="proposed-solutions---preamble">Proposed Solutions - Preamble</a></h4>
<p>There are few different ways of controlling the message recognition, and each one have its drawbacks. The program can either be configured prior to the runtime to expect different messages on different communication mediums, be it kafka topic, or GRPC endpoint, or the code can be placed to expect different markers describing the message type and format and act on those.</p>
<p>Proposed below are detailed designs on how this issue can be handled:</p>
<h5><a class="header" href="#solution-i---separate-endpoints" id="solution-i---separate-endpoints">Solution I - Separate Endpoints</a></h5>
<p>Each format will have a corresponding abstract transport endpoint. In this case, for each available ingestion method we have to specify different handling methods, due to the nature of each communication medium:</p>
<ul>
<li>Kafka would receive a separate topic to use with MessagePack, or use one topic, however in that case, each partition would have different type of messages, and format mixing would have to be avoided</li>
<li>RabbitMQ would receive separate queue to use with MessagePack</li>
<li>GRPC would have separate endpoint</li>
</ul>
<h6><a class="header" href="#notes" id="notes">Notes</a></h6>
<ul>
<li>No testing nor PoC was created for this solution, please treat it as being theoretical.</li>
<li>Having separate endpoints will result in CDL not being able to keep the ordering as described in the ordering rfc. It has to be noted that this should not be a problem, as it would be highly unordinarily to interact with a system that, while being focused on message ordering, is using multiple message formats at once. Nevertheless, this limitation have to be considered and, if this solution will be chosen, additional documentation have to be prepared, and this limitation MUST be highlighted.</li>
</ul>
<h6><a class="header" href="#major-concerns" id="major-concerns">Major Concerns</a></h6>
<ul>
<li>This design will result in multiple configurations that have to be tested separately of each other and in tandem.</li>
<li>Some amount of additional configuration have to be added.</li>
<li>Separate endpoints can be misused, resulting in a cascade of errors. Additional error handling has to be introduced to discern the type of issue, and whatever it was related to format errors or not.</li>
<li>Parallel usage of two or more endpoints may end up in thread starvation on constrained machines. In such example, by having one thread available for the workload, the focus would be shifted to one endpoint over another. This is an infrastructure related issue, but it has to be considered in this context.</li>
</ul>
<h6><a class="header" href="#performance-1" id="performance-1">Performance</a></h6>
<ul>
<li>From initial evaluation it seems that this solution should not have any considerable performance drawbacks.</li>
<li>Parallel usage can result in performance degradation, however this is only a theoretical issue, and was not proven by testing yet due to pre-PoC state of the feature and no observed evidences of this behavior in other parts of  the CDL.</li>
</ul>
<h5><a class="header" href="#solution-ii---single-endpoint-with-metadata-carrier" id="solution-ii---single-endpoint-with-metadata-carrier">Solution II - single endpoint with metadata carrier</a></h5>
<p>Both formats can use this same, abstract, transport endpoint. All the information required to control DR behavior and informing about the state of the message, will be provided in the transport's metadata. This means that we can retain the simplicity of having one, non-specific endpoint, where both message formats will be received.</p>
<p>After preliminary research, it seems that all the protocols can, in theory, pass metadata context alongside the payload.</p>
<h5><a class="header" href="#notes-1" id="notes-1">Notes</a></h5>
<ul>
<li>For GRPC transport, information about the format would have to be contained in the header, or separate GRPC call</li>
<li>For Kafka and RabbitMQ, metadata can be stored in headers.</li>
<li>Detached tests were executed, in which CDL context was not used, mostly focused on the availability and usability of the libraries, and it’s support. Additionally, PoC was not created for this solution, please treat it as being theoretical.</li>
</ul>
<h5><a class="header" href="#major-concerns-1" id="major-concerns-1">Major Concerns</a></h5>
<ul>
<li>All the future transports will have to support sending some kind of metadata alongside the payload itself. This is quite possible but not guaranteed for all the users in all the use cases. In case new transport will be proposed, and it will not support it, it will have to be discarded or result in reopening this feature while choosing another solution.</li>
<li>Each transport have to get additional code, handling different ways of getting, and possibly parsing, the metadata provided with the message.</li>
<li>It was also stated on the internal meetings that clients and/or libraries in different languages may have problems with this functionality, as it is not widely used. As per project directives, CDL have to be compatible with different languages, and this may be a potential issue.</li>
</ul>
<h5><a class="header" href="#performance-2" id="performance-2">Performance</a></h5>
<ul>
<li>Assuming the difference in metadata formats and our ability to both parse and serialize it, it can be safely assumed that performance will not suffer, however it depends on the way each library will get and use the metadata provided with the message. Comparing to the usual <code>O(m*m℘)</code> where <code>m</code> is the message size and <code>m℘</code> is the parsing cost, this solution will cost roughly <code>O((m*m℘) + (n*n℘))</code> where <code>n</code> and <code>n℘</code> is metadata length and its parsing cost respectively.</li>
</ul>
<h5><a class="header" href="#solution-iii---single-endpoint-with-format-recognition" id="solution-iii---single-endpoint-with-format-recognition">Solution III - single Endpoint With Format Recognition</a></h5>
<p>In this solution, both formats can be sent to one transport endpoint, similarly to the design proposed in Solution II, the message will not contain metadata in itself, but parsing will be performed for each available serialization method. In case all the methods fail, the message will be considered malformed and handled the usual way, which means reporting the error and continuing to work on the next queued message.</p>
<h5><a class="header" href="#notes-2" id="notes-2">Notes</a></h5>
<ul>
<li>The Nature of this solution and its performance review, introduces the term &quot;Cost of Failure&quot; which is a measure <code>𝜅</code> that can be described as <code>0&lt;𝜅&lt;=m</code>, where m is the length of the message.
<ul>
<li>It describes the ability of the underlying library to recognize the format or fail in the case error.  The earlier the library can recognize parsing error, the lower is the <code>𝜅</code>, and the earlier code can react to the error.</li>
<li>Moreover, <code>𝜅</code> is also related to the attached function, in that case<code>n*𝜅</code> means:
<code>for x in n, return 𝜅(x)</code></li>
<li>It has to be, by definition fluid, and if not argued otherwise, taken at worst-case scenario rate.</li>
<li>In the layman's terms, lower <code>𝜅</code> is better, and until stated otherwise, defaults to <code>𝜅==m</code></li>
</ul>
</li>
<li>Detached tests were executed, in which CDL context was not used, additionally PoC was not created for this solution, please treat it as being theoretical.</li>
</ul>
<h5><a class="header" href="#major-concerns-2" id="major-concerns-2">Major Concerns</a></h5>
<ul>
<li>Cost of Failure will scale alongside the number of formats. Currently, this is limited to two which this document describes, although this is only true for the current state, and it may or may not change in the future.</li>
<li>Different libraries providing support for either JSON and MessagePack can behave differently. Cost of Failure, in those, is not documented or at least not easily available. Due to that, it would be wise that to assume the worst scenario, which is <code>𝜅==m</code> for each deserialization method.</li>
</ul>
<h5><a class="header" href="#performance-3" id="performance-3">Performance</a></h5>
<ul>
<li>Comparing the performance to the other designs mentioned before, clearly shows that it is potentially more costly, ranging anywhere from <code>0</code> to <code>n*𝜅</code> where <code>n</code> is the number of formats CDL supports (currently this document describes the second format) assuming the worst scenario where <code>𝜅=m</code></li>
</ul>
<h5><a class="header" href="#potential-improvements" id="potential-improvements">Potential Improvements</a></h5>
<ul>
<li>
<p>assuming that one of the deserialization methods will fail, it is possible to parallelize those and to try to get at least one result out of several methods. This may improve performance to up to a single <code>𝜅</code>, while degrading memory usage (due to the possibility that deserialization methods will be destructive in the context of the used language) and requiring n threads to start working on the same message at the same time. This may prove helpful in cases when the user will want to use different formats and mix messages. Withal, it will be more troublesome to use for users that are using either one or the other.</p>
</li>
<li>
<p>Format recognition can be adjusted per queue. Assuming that the user will either send one format or the other, for each queue, it is possible for DR to keep information in its cache or configuration, informing code what to expect. The proposed solution would be to add a counter for each transport, that would track the ratio of formats that were successfully recognized and in which format they appear to be sent. This would help &quot;guess&quot; which of the deserialization methods have the best chances of success on a given queue. This will improve performance of this design in both edge cases (one type of message arriving via transport) and in case of mixed messages, without introducing severe performance issues.</p>
</li>
</ul>
<h5><a class="header" href="#solution-iv---single-endpoint-with-deserialization-marker" id="solution-iv---single-endpoint-with-deserialization-marker">Solution IV - Single Endpoint With Deserialization Marker</a></h5>
<p>This design uses some kind of marker that allows to easily discover what type of message arrived. There is potentially a few different ways to solve it each with its issue, all the same it is more of an expansion. Solutions like this are very low-level and usually are, but not always, tailored for specific usage and not generic, which is the opposite of what CDL tries to be.</p>
<ol>
<li>
<p>First byte:
If we can assume that the JSON formatted message will start  with either byte 0x5B &quot;<code>[</code>&quot; or 0x7B &quot;<code>{</code>&quot;.
In this case, we can check the first character that arrives, and decide the message format on that information. This also may be implemented as an improvement for Solution III. This method assumes that the message will not start with a non-whitespace character, and MessagePack will not use those bytes for its own serialization methods (which according to its specification will be the case). Please note that this option may result in unnecessary and heavy CPU branching if done incorrectly, while not providing many tools and methods to prevent it.</p>
</li>
<li>
<p>Extension (header) check:
This is the same method as the one adverted above, nonetheless in this case, correct behavior can be ensured using MessagePack's extension types. Unfortunately, it is unsure by reading the specification whenever the header or appendix is created to accommodate extension data. In this case, Empiric testing was proven successful in determining that for a specific implementation, <code>messagepack-rs</code> it is indeed a header consisting of bytes <code>0xD6</code> which, according to specification, represent the <code>ext</code> family of formats. However, one issue is apparent, which is a severely lacking support for user extensions in rust libraries, of which at least one out of 5 supported it. Rust support were found in the &quot;First that works&quot; approach, and it is unclear what support is available for the other languages, nevertheless support is apparent and well-defined in MessagePack specification.
<a href="https://github.com/msgpack/msgpack/blob/3f0a9aae716596a86878c0d68dc0bd4256673202/spec.md">MessagePack Specification</a></p>
</li>
<li>
<p>Marker injection
Last and &quot;dirtiest&quot; option is to inject the required specific byte before or after the payload. This option is guaranteed to break support on the client side, and simply judging from the sheer volume of changes on both sides of the CDL system, is heavily discouraged.</p>
</li>
</ol>
<h5><a class="header" href="#notes-3" id="notes-3">Notes</a></h5>
<p>Suggested changes require alteration in v1 specification to force users to trim the messages from white spaces before committing them to the transport.
The Cost of Failure for this solution is 0(1), presumably also confined to one branch operation.</p>
<h5><a class="header" href="#major-concerns-3" id="major-concerns-3">Major Concerns</a></h5>
<ul>
<li>Changes to existing v1 spec that are not clear or apparent. It means that v1 format will not change, but the way of delivery will. It is unclear right now how to announce those changes and if those should result in v2 format specification or not, also it is not known if the trimming should be used on the side of the receiver or the sender.</li>
<li>Depending on specification and partial loss of flexibility - DR will now employ another set of restrictions, however minor, to the message format to be able to correctly and concisely discern the incoming content format.</li>
</ul>
<h5><a class="header" href="#solution-v---single-endpoint-with-specific-deserialization-focus" id="solution-v---single-endpoint-with-specific-deserialization-focus">Solution V - Single Endpoint With Specific Deserialization Focus</a></h5>
<p>The Method presented here will be the simplest, albeit with some drawbacks. Taking into consideration the scalability of the DR, we can provide multiple DR instances with configurations that are in counterbalance to each other. Providing this is the second format that is intended to be supported, two instances should be perfectly able to cover all the cases, in which the first instance will look for JSON formatted messages, and the second will respond on MessagePack payload.
This method will work with different configurations, especially in the case in which the user will use explicitly one format over another and use CDL system with that knowledge in hand. Configuration MUST be provided during the application startup.</p>
<h6><a class="header" href="#major-concerns-4" id="major-concerns-4">Major Concerns</a></h6>
<ul>
<li>This design will have to be extended with better error handling that the one that is present currently. In case there will be mixed-message scenario, where multiple formats are used in tandem, there is a guarantee that either instance will throw a deserialization error, as it will be configured to handle a different format.</li>
</ul>
<h6><a class="header" href="#notes-4" id="notes-4">Notes</a></h6>
<p>No testing nor PoC was created for this solution, please treat it as being theoretical.</p>
<h2><a class="header" href="#further-considerations" id="further-considerations">Further Considerations</a></h2>
<h4><a class="header" href="#impact-on-other-teams" id="impact-on-other-teams">Impact on Other Teams</a></h4>
<p>Depending on the chosen solution, we may have to notify all users about the changes. It may also be necessary to introduce those as a &quot;breaking change&quot;.</p>
<h4><a class="header" href="#scalability" id="scalability">Scalability</a></h4>
<p>Using Solution I may result in additional endpoints that have to be either provided or created. Apart from that, from initial research, there appear to be no impact on scalability whatsoever.</p>
<h4><a class="header" href="#availability-problems" id="availability-problems">Availability Problems</a></h4>
<p>Some of the solutions depends on the specific usage and/or implementation of the specific libraries and languge support. It is encouraged to put additional effort in weighting the specific solution against the other.</p>
<h4><a class="header" href="#testing" id="testing">Testing</a></h4>
<p>This feature MUST undergo thorough testing before being accepted. Test cases MUST include:</p>
<ul>
<li>Failure scenarios:
<ul>
<li>Edge scenarios where messages are unreadable or follow worst-case scenario path.</li>
</ul>
</li>
<li>Malformed messages:
<ul>
<li>reaction of the software to malformed or misaligned messages.</li>
</ul>
</li>
<li>Happy test:
<ul>
<li>Proper behavior with proper values.</li>
</ul>
</li>
<li>Format testing for each, readily available repository type:
<ul>
<li>Document storage.</li>
<li>Time series storage.</li>
<li>Binary storage.</li>
</ul>
</li>
<li>Performance testing with all the before mentioned cases:</li>
</ul>
<h4><a class="header" href="#workload-estimation" id="workload-estimation">Workload Estimation</a></h4>
<p>Success rate should be acceptable, considering there is not a lot of solution-sepcific logic to introduce. Depending on which solution is chosen. It is initially roughly estimated to 20MD</p>
<h2><a class="header" href="#deliberation" id="deliberation">Deliberation</a></h2>
<h4><a class="header" href="#out-of-scope" id="out-of-scope">Out of Scope</a></h4>
<ul>
<li>Any other, not mentioned features, were not taken into consideration in this scope. Especially versioning (CDLF-00010-00)</li>
<li>Communication within CDL system itself, and an output format are out of the scope of this document.</li>
</ul>
<h4><a class="header" href="#open-questions" id="open-questions">Open Questions</a></h4>
<ul>
<li>Usage and behavior in Service mesh can not be checked at this point. This RFC should be revisited when the feature is complete and testing can be performed.</li>
<li>CDLF-0000D-00 - Service Meshing - format handling changes should not affect Service Meshing itself, however at this point in time it is hard to guarantee that.</li>
</ul>
<h4><a class="header" href="#notes-5" id="notes-5">Notes</a></h4>
<ul>
<li>CDLF-00009-00 - Message Batching - have to be taken into consideration while writing this feature</li>
<li>CDLF-0000A-00 - Message Ordering - guaranteeing order in case of mixed formats will not be possible, albeit while using a specific format or different endpoint, order can be enforced.</li>
</ul>
<h3><a class="header" href="#end-matter" id="end-matter">End Matter</a></h3>
<p>This is the version of the RFC that was deliberately cut down to ingestible size and format. The number of cases and solutions were condensed to those that were considered by the researcher the most valuable, leaving out minor variation that can be deduced from already provided solutions.</p>
<h5><a class="header" href="#references" id="references">References</a></h5>
<p>MessagePack related materials:
<a href="https://github.com/msgpack/msgpack/blob/3f0a9aae716596a86878c0d68dc0bd4256673202/spec.md">MessagePack Specification</a>
<a href="https://thephp.website/en/issue/messagepack-vs-json-benchmark/">MessagePack Benchmark</a>
<a href="https://msgpack.org/">MessagePack Project</a></p>
<p>CDL :
<a href="https://github.com/epiphany-platform/CommonDataLayer">CDL project</a></p>
<p>References to notable rust libraries used in research:
<a href="https://lib.rs/crates/messagepack-rs">messagepack-rs (library with user extensions for Rust)</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../rfc/0004_Commit_message_formalization_and_enforcement_01.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../rfc/0002_Materialization_01.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../rfc/0004_Commit_message_formalization_and_enforcement_01.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../rfc/0002_Materialization_01.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
